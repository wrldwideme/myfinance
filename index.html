<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Expenses Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg: #0b0b0f;
      --card: #1c1c1e;
      --muted: rgba(255,255,255,.65);
      --text: #ffffff;
      --border: rgba(255,255,255,.08);
      --accent: #2ea6ff;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --radius: 16px;
    }

    /* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ */
    .light-theme {
      --bg: #ffffff;
      --card: #f8f9fa;
      --muted: rgba(0,0,0,.65);
      --text: #1c1c1e;
      --border: rgba(0,0,0,.08);
      --accent: #2ea6ff;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
    }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      transition: background-color 0.3s, color 0.3s;
      overscroll-behavior-y: contain;
    }

    .wrap { padding: 14px 14px 88px; }

    /* Pull-to-Refresh –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä */
    .ptr-indicator {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      pointer-events: none;
      opacity: 0;
      transform: translateY(-100%);
      transition: opacity 0.3s, transform 0.3s;
    }

    .ptr-indicator.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .ptr-spinner {
      width: 24px;
      height: 24px;
      border: 2px solid transparent;
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: ptr-spin 0.6s linear infinite;
    }

    @keyframes ptr-spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin: 6px 0 12px;
    }
    .app-title{
      font-weight: 700;
      font-size: 18px;
      letter-spacing: .2px;
    }

    .seg{
      display:flex;
      gap:6px;
      background: var(--card);
      border:1px solid var(--border);
      padding: 6px;
      border-radius: 999px;
    }
    .seg button{
      border:0;
      background: transparent;
      color: var(--muted);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 13px;
      cursor:pointer;
    }
    .seg button.active{
      background: var(--accent);
      color: var(--text);
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
      margin-bottom: 10px;
      transition: background-color 0.3s, border-color 0.3s;
    }

    .row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }
    .label{
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 6px;
    }
    .big{
      font-size: 28px;
      font-weight: 800;
      letter-spacing: .2px;
      line-height: 1.1;
    }
    .sub{
      color: var(--muted);
      font-size: 13px;
      margin-top: 6px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.05);
      border:1px solid var(--border);
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
    }
    .light-theme .pill {
      background: rgba(0,0,0,.05);
    }
    .pill.warn{ color: #ff9500; }
    .pill.ok{ color: #34c759; }
    .pill.bad{ color: #ff3b30; }

    .list{ margin-top: 6px; }
    .item{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding: 10px 0;
      border-top: 1px solid var(--border);
    }
    .item:first-child{ border-top: 0; }
    .item .left{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 0;
    }
    .item .name{
      font-size: 14px;
      font-weight: 600;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 230px;
    }
    .item .meta{
      color: var(--muted);
      font-size: 12px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .item .right{
      text-align:right;
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-end;
    }
    .amt{
      font-weight: 800;
      font-size: 14px;
    }
    .mini-btn{
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--muted);
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 12px;
      cursor:pointer;
    }
    .mini-btn.danger{ color: #ff3b30; }

    .btn{
      width: 100%;
      border:0;
      background: var(--accent);
      color: #ffffff;
      font-weight: 800;
      padding: 14px 14px;
      border-radius: 14px;
      cursor:pointer;
      font-size: 16px;
      margin-top: 10px;
    }

    .input{
      width: 100%;
      box-sizing: border-box;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 16px;
      outline: none;
      transition: background-color 0.3s, border-color 0.3s;
    }
    .input::placeholder{ 
      color: var(--muted);
      opacity: 0.5;
    }

    /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è input date –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
    .input[type="date"] {
      -webkit-appearance: none;
      appearance: none;
      min-height: 44px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ —Ç–∞–ø–∞ */
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è WebKit –±—Ä–∞—É–∑–µ—Ä–æ–≤ (iOS, Chrome) */
    .input[type="date"]::-webkit-calendar-picker-indicator {
      background-size: 20px;
      padding: 4px;
      cursor: pointer;
      opacity: 0.7;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è Firefox */
    .input[type="date"]::-moz-focus-inner {
      border: 0;
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
    @media (max-width: 480px) {
      .input[type="date"] {
        font-size: 14px;
        padding: 10px 12px;
      }
      
      /* –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —ç–∫—Ä–∞–Ω–∞ */
      .modal {
        margin: 0 10px;
        max-width: calc(100% - 20px);
      }
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .nav{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      background: var(--card);
      backdrop-filter: blur(14px);
      border-top: 1px solid var(--border);
      display:flex;
      gap: 8px;
      z-index: 90;
    }
    .nav button{
      flex: 1;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--muted);
      padding: 10px 8px;
      border-radius: 14px;
      font-size: 13px;
      cursor:pointer;
    }
    .nav button.active{
      color: var(--accent);
      border-color: var(--accent);
      background: rgba(46,166,255,.1);
    }

    .hint{
      color: var(--muted);
      font-size: 12px;
      margin-top: 8px;
      line-height: 1.35;
    }

    .divider{
      height: 1px;
      background: var(--border);
      margin: 10px 0;
    }

    .loading{
      display:flex; gap:10px; align-items:center; color: var(--muted);
    }
    .dot{
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--muted);
      opacity: 0.5;
      animation: pulse 1s infinite ease-in-out;
    }
    .dot:nth-child(2){ animation-delay: .15s; }
    .dot:nth-child(3){ animation-delay: .3s; }
    @keyframes pulse{
      0%,100%{ transform: scale(1); opacity: .5; }
      50%{ transform: scale(1.35); opacity: 1; }
    }
  
    /* Analytics visuals */
    .kpis{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .kpi{
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: 16px;
      padding: 12px;
    }
    .kpi .kpi-label{ font-size: 12px; color: var(--muted); }
    .kpi .kpi-value{ font-size: 20px; font-weight: 800; margin-top: 6px; }
    .kpi .kpi-sub{ font-size: 12px; color: var(--muted); margin-top: 6px; }

    /* –£–ª—É—á—à–µ–Ω–Ω—ã–π Donut —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π */
    .donut-wrap{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap: 12px;
      align-items:center;
      margin-top: 10px;
    }
    .donut{
      width: 140px;
      height: 140px;
      border-radius: 50%;
      position: relative;
      border: 1px solid var(--border);
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
      animation: donutAppear 0.8s ease-out;
    }
    .donut-chart {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      position: absolute;
      top: 0;
      left: 0;
    }
    .donut::after{
      content:'';
      position:absolute;
      inset: 16px;
      border-radius: 50%;
      background: var(--bg);
      border: 1px solid var(--border);
      z-index: 1;
    }
    .donut-center{
      position:absolute;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      z-index: 2;
      pointer-events:none;
      text-align:center;
      padding: 0 14px;
      animation: textAppear 0.8s ease-out 0.3s both;
    }
    .donut-center .dc-big{ font-weight: 900; font-size: 16px; }
    .donut-center .dc-sub{ font-size: 12px; color: var(--muted); margin-top: 4px; }

    @keyframes donutAppear {
      0% {
        transform: scale(0.8);
        opacity: 0;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    @keyframes textAppear {
      0% {
        opacity: 0;
        transform: translateY(10px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–æ–≤ donut */
    @keyframes segmentAppear {
      0% {
        transform: rotate(0deg) scale(0);
        opacity: 0;
      }
      100% {
        transform: rotate(0deg) scale(1);
        opacity: 1;
      }
    }
    
    .segment-path {
      transform-origin: 70px 70px;
      animation: segmentAppear 0.6s ease-out forwards;
    }

    .legend{
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    .legend-row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding: 8px 10px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--card);
    }
    .legend-left{
      display:flex;
      align-items:flex-start;
      gap:10px;
      min-width: 0;
    }
    .dotc{
      width: 10px; height: 10px;
      border-radius: 999px;
      margin-top: 4px;
      flex: 0 0 auto;
      background: var(--accent);
    }
    .legend-name{
      font-size: 13px;
      font-weight: 700;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 180px;
    }
    .legend-sub{
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }
    .spark{
      margin-top: 10px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: var(--card);
      padding: 10px;
    }
    .spark svg{ width: 100%; height: 70px; display:block; }
    .spark .spark-meta{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-top: 8px;
      color: var(--muted);
      font-size: 12px;
    }
    .muted{ color: var(--muted); }

  
    /* ===== Analytics extras ===== */
    .kpi-row{ 
      display:flex; 
      gap:10px; 
      margin-top:10px; 
    }
    .kpi{ 
      flex:1; 
      background: var(--card); 
      border:1px solid var(--border); 
      border-radius: 14px; 
      padding: 10px; 
    }
    .kpi .k{ 
      color: var(--muted); 
      font-size: 12px; 
      margin-bottom: 4px; 
    }
    .kpi .v{ 
      font-weight: 800; 
      font-size: 15px; 
    }
    .kpi .v .delta-pill {
      display: block;
      font-size: 11px;
      margin-top: 2px;
      padding: 2px 6px;
      border-radius: 8px;
      background: rgba(46,166,255,.1);
      color: var(--accent);
      width: fit-content;
    }
    .kpi .v .delta-pill.warn {
      background: rgba(255,149,0,.1);
      color: #ff9500;
    }
    .kpi .v .delta-pill.ok {
      background: rgba(52,199,89,.1);
      color: #34c759;
    }

    .donut-wrap{ display:flex; gap:14px; align-items:center; margin-top: 10px; }
    .donut{
      width: 140px; height: 140px;
      border-radius: 50%;
      position: relative;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      flex: 0 0 auto;
      animation: donutAppear 0.8s ease-out;
    }
    .donut::after{
      content:'';
      position:absolute;
      inset: 22%;
      border-radius: 50%;
      background: var(--bg);
      border: 1px solid var(--border);
      z-index: 1;
    }
    .donut-center{
      position:absolute;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      z-index: 2;
      text-align:center;
      padding: 10px;
      pointer-events:none;
      animation: textAppear 0.8s ease-out 0.3s both;
    }
    .donut-center .t{ font-weight: 900; font-size: 14px; }
    .donut-center .s{ color: var(--muted); font-size: 11px; margin-top: 4px; }

    .legend{ flex: 1; min-width: 0; }
    .legend .lg-item{ 
      display:flex; 
      align-items:flex-start; 
      justify-content:space-between; 
      gap:10px; 
      padding: 8px 0; 
      border-top:1px solid var(--border); 
      animation: legendItemAppear 0.5s ease-out;
      animation-fill-mode: both;
    }
    .legend .lg-item:nth-child(1) { animation-delay: 0.1s; }
    .legend .lg-item:nth-child(2) { animation-delay: 0.2s; }
    .legend .lg-item:nth-child(3) { animation-delay: 0.3s; }
    .legend .lg-item:nth-child(4) { animation-delay: 0.4s; }
    .legend .lg-item:nth-child(5) { animation-delay: 0.5s; }
    .legend .lg-item:first-child{ border-top:0; padding-top:0; }
    
    @keyframes legendItemAppear {
      0% {
        opacity: 0;
        transform: translateY(10px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .lg-left{ display:flex; flex-direction:column; gap:3px; min-width: 0; }
    .lg-name{ display:flex; align-items:center; gap:8px; font-weight: 650; font-size: 14px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .sw{ width:10px; height:10px; border-radius: 3px; flex:0 0 auto; margin-top: 3px; }
    .lg-meta{ color: var(--muted); font-size: 12px; }
    .lg-right{ text-align:right; display:flex; flex-direction:column; gap:4px; align-items:flex-end; }
    .lg-amt{ font-weight: 900; font-size: 13px; white-space:nowrap; }

    .spark{ margin-top: 12px; }
    .spark svg{ width: 100%; height: 64px; display:block; }
    .spark .cap{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 6px; }
    .spark .cap .label{ margin:0; }

    /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è */
    .add-btn-container {
      position: fixed;
      right: 20px;
      bottom: 90px;
      z-index: 100;
    }
    
    .add-btn {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--accent);
      border: none;
      color: #ffffff;
      font-size: 28px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(46, 166, 255, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .add-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(46, 166, 255, 0.4);
    }
    
    .add-btn:active {
      transform: scale(0.95);
    }
    
    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      opacity: 0;
      animation: fadeIn 0.2s forwards;
    }
    
    @keyframes fadeIn {
      to { opacity: 1; }
    }
    
    .modal {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      width: 100%;
      max-width: 400px;
      box-shadow: var(--shadow);
      transform: translateY(20px);
      animation: slideUp 0.3s forwards;
      box-sizing: border-box;
    }
    
    @keyframes slideUp {
      to { transform: translateY(0); }
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
    }
    
    .close-btn {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 24px;
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: background-color 0.2s;
    }
    
    .close-btn:hover {
      background: rgba(0,0,0,.05);
    }
    .light-theme .close-btn:hover {
      background: rgba(0,0,0,.05);
    }
    
    /* –ù–æ–≤—ã–µ —Ü–≤–µ—Ç–∞ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ä–∞—Å—Ö–æ–¥–æ–≤ */
    .expense-low { color: #34c759; } /* –ó–µ–ª–µ–Ω—ã–π */
    .expense-medium { color: #ff9500; } /* –û—Ä–∞–Ω–∂–µ–≤—ã–π */
    .expense-high { color: #ff3b30; } /* –ö—Ä–∞—Å–Ω—ã–π */
    .expense-neutral { color: var(--accent); } /* –ê–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç */

    /* –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }
    
    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .empty-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
    }
    
    .empty-description {
      font-size: 14px;
      line-height: 1.4;
      max-width: 280px;
      margin: 0 auto;
    }

    /* –£–ª—É—á—à–µ–Ω–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è sparkline */
    .sparkline-path {
      stroke-dasharray: 1000;
      stroke-dashoffset: 1000;
      animation: drawSparkline 1.5s ease-out forwards;
    }
    
    .sparkline-fill {
      opacity: 0;
      animation: fadeInFill 0.8s ease-out 0.5s forwards;
    }
    
    @keyframes drawSparkline {
      to {
        stroke-dashoffset: 0;
      }
    }
    
    @keyframes fadeInFill {
      to {
        opacity: 0.1;
      }
    }
  </style>
</head>

<body>
  <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä Pull-to-Refresh -->
  <div id="ptrIndicator" class="ptr-indicator">
    <div class="ptr-spinner"></div>
  </div>

  <div id="app" class="wrap"></div>
  
  <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
  <div class="add-btn-container">
    <button class="add-btn" onclick="showAddModal()">+</button>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
  <div id="addModal" class="modal-overlay" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞—Ç—É</div>
        <button class="close-btn" onclick="closeAddModal()">√ó</button>
      </div>
      <div class="label">–°—É–º–º–∞</div>
      <input class="input" id="modalAmount" type="number" inputmode="decimal" placeholder="350" />
      
      <div class="label" style="margin-top:10px;">–û–ø–∏—Å–∞–Ω–∏–µ</div>
      <input class="input" id="modalDescription" placeholder="–∫–æ—Ñ–µ, —Ç–∞–∫—Å–∏, –ø—Ä–æ–¥—É–∫—Ç—ã..." />
      
      <div class="label" style="margin-top:10px;">–î–∞—Ç–∞</div>
      <input class="input" id="modalDate" type="date" />
      
      <button class="btn" onclick="submitExpenseModal()" style="margin-top: 20px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>

  <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è —Å 3 –∫–Ω–æ–ø–∫–∞–º–∏ -->
  <div class="nav">
    <button id="tab0" onclick="showDashboard()" class="active">üè† –°–µ–π—á–∞—Å</button>
    <button id="tab1" onclick="showAnalytics()">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
    <button id="tab2" onclick="showRecent()">üßæ –¢—Ä–∞—Ç—ã</button>
  </div>

<script>
/* ======================================================
   TELEGRAM INIT
====================================================== */
let tg;
try {
  tg = window.Telegram?.WebApp;
  if (tg) {
    tg.expand();
    const p = tg.themeParams || {};
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ü–≤–µ—Ç–æ–≤–æ–π —Å—Ö–µ–º—ã
    if (tg.colorScheme === 'light') {
      document.documentElement.classList.add('light-theme');
    } else {
      document.documentElement.classList.add('dark-theme');
    }
    
    // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç–∞ –µ—Å–ª–∏ –æ–Ω–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã
    if (p.bg_color) document.documentElement.style.setProperty('--bg', p.bg_color);
    if (p.text_color) document.documentElement.style.setProperty('--text', p.text_color);
    if (p.hint_color) document.documentElement.style.setProperty('--muted', p.hint_color);
    if (p.button_color) document.documentElement.style.setProperty('--accent', p.button_color);
    
    // –î–ª—è —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º—ã Telegram —Ç–æ–∂–µ –º–æ–∂–µ—Ç –ø–µ—Ä–µ–¥–∞—Ç—å —Ü–≤–µ—Ç–∞
    if (tg.colorScheme === 'light') {
      if (!p.bg_color) document.documentElement.style.setProperty('--bg', '#ffffff');
      if (!p.text_color) document.documentElement.style.setProperty('--text', '#1c1c1e');
      if (!p.hint_color) document.documentElement.style.setProperty('--muted', 'rgba(0,0,0,.65)');
    }

    // –í–∫–ª—é—á–∞–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–π Pull-to-Refresh –≤ Telegram Web App
    tg.enablePullToRefresh();
    tg.onEvent('pullToRefresh', handlePullToRefresh);
  }
} catch (e) {
  console.warn('Telegram WebApp not available:', e);
  tg = null;
}

/* ======================================================
   PULL-TO-REFRESH IMPLEMENTATION
====================================================== */
let isRefreshing = false;
let touchStartY = 0;
let touchCurrentY = 0;
const ptrIndicator = document.getElementById('ptrIndicator');
const appContainer = document.getElementById('app');

// –ù–∞—Ç–∏–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ Pull-to-Refresh –≤ Telegram
async function handlePullToRefresh() {
  if (isRefreshing) return;
  
  isRefreshing = true;
  
  try {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
    ptrIndicator.classList.add('visible');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —ç–∫—Ä–∞–Ω
    await refreshCurrentScreen();
    
    // –¢–∞–∫—Ç–∏–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –≤ Telegram
    tg?.HapticFeedback?.notificationOccurred('success');
  } catch (error) {
    console.error('Refresh error:', error);
    tg?.HapticFeedback?.notificationOccurred('error');
  } finally {
    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
    ptrIndicator.classList.remove('visible');
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Pull-to-Refresh –≤ Telegram
    tg?.closePullToRefresh();
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥
    setTimeout(() => {
      isRefreshing = false;
    }, 500);
  }
}

// –§–æ–ª–ª–±—ç–∫ –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞ (–µ—Å–ª–∏ –Ω–µ –≤ Telegram)
function initPullToRefreshFallback() {
  if (tg) return; // –ù–µ –Ω—É–∂–Ω–æ –≤ Telegram
  
  document.addEventListener('touchstart', (e) => {
    if (isRefreshing || window.scrollY > 10) return;
    touchStartY = e.touches[0].clientY;
  });

  document.addEventListener('touchmove', (e) => {
    if (isRefreshing || window.scrollY > 10) return;
    
    touchCurrentY = e.touches[0].clientY;
    const diff = touchCurrentY - touchStartY;
    
    if (diff > 0 && window.scrollY === 0) {
      e.preventDefault();
      const progress = Math.min(diff / 100, 1);
      ptrIndicator.style.opacity = progress;
      ptrIndicator.style.transform = `translateY(${Math.min(diff, 60)}px)`;
    }
  });

  document.addEventListener('touchend', async (e) => {
    if (isRefreshing || window.scrollY > 10) return;
    
    const diff = touchCurrentY - touchStartY;
    
    if (diff > 80) {
      isRefreshing = true;
      ptrIndicator.classList.add('visible');
      
      try {
        await refreshCurrentScreen();
      } catch (error) {
        console.error('Refresh error:', error);
      } finally {
        setTimeout(() => {
          ptrIndicator.classList.remove('visible');
          isRefreshing = false;
        }, 1000);
      }
    } else {
      ptrIndicator.classList.remove('visible');
    }
    
    touchStartY = 0;
    touchCurrentY = 0;
  });
}

// –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —ç–∫—Ä–∞–Ω–∞
async function refreshCurrentScreen() {
  if (activeScreen === 'dashboard') {
    await showDashboard();
  } else if (activeScreen === 'analytics') {
    await showAnalytics();
  } else if (activeScreen === 'recent') {
    await showRecent();
  }
}

/* ======================================================
   üîå API WEBHOOKS
====================================================== */
const N8N_BASE = 'https://n8n.todobotmy.ru/webhook';

const API = {
  DASHBOARD: `${N8N_BASE}/fin-dashboard`,
  ANALYTICS: `${N8N_BASE}/fin-analytics`,
  RECENT: `${N8N_BASE}/fin-expenses-recent`,
  ADD_EXPENSE: `${N8N_BASE}/fin-expenses-add`,
  UPDATE_EXPENSE: `${N8N_BASE}/fin-expenses-update`,
  DELETE_EXPENSE: `${N8N_BASE}/fin-expenses-delete`
};

const app = document.getElementById('app');

/* ======================================================
   –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û
====================================================== */
function showAddModal() {
  const modal = document.getElementById('addModal');
  const today = nowISODate();
  document.getElementById('modalDate').value = today;
  document.getElementById('modalAmount').value = '';
  document.getElementById('modalDescription').value = '';
  modal.style.display = 'flex';
  
  // –§–æ–∫—É—Å –Ω–∞ —Å—É–º–º—É
  setTimeout(() => {
    document.getElementById('modalAmount').focus();
  }, 100);
}

function closeAddModal() {
  document.getElementById('addModal').style.display = 'none';
}

/* ======================================================
   HELPERS
====================================================== */
function setActiveTab(i){
  for (let k=0;k<3;k++){
    const btn = document.getElementById('tab'+k);
    if (btn) btn.classList.toggle('active', k===i);
  }
}

function fmtMoney(n, currency='‚ÇΩ'){
  if (n === null || n === undefined || n === '') return '‚Äî';
  const num = Number(n);
  if (Number.isNaN(num)) return String(n);
  return new Intl.NumberFormat('ru-RU').format(num) + ' ' + currency;
}

function nowISODate(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}

function monthKey(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  return `${yyyy}-${mm}`;
}

function loadingCard(text='–ó–∞–≥—Ä—É–∑–∫–∞'){
  return `
    <div class="card">
      <div class="loading">
        <span>${text}</span>
        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
      </div>
    </div>
  `;
}

function buildUrl(url, params){
  const u = new URL(url);
  Object.entries(params || {}).forEach(([k,v]) => {
    if (v !== undefined && v !== null && v !== '') u.searchParams.set(k, String(v));
  });
  return u.toString();
}

function escapeHtml(str){
  const s = String(str ?? '');
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

function unwrapN8n(x){
  if (Array.isArray(x)) return x[0] ?? {};
  return x ?? {};
}

function labelForPeriod(p){
  if (p==='today') return '–°–µ–≥–æ–¥–Ω—è';
  if (p==='week') return '–ù–µ–¥–µ–ª—è';
  return '–ú–µ—Å—è—Ü';
}

function colorForIndex(i){
  // –£–ø–æ—Ä—è–¥–æ—á–µ–Ω–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ü–≤–µ—Ç–æ–≤
  const colors = [
    '#2ea6ff',  // –æ—Å–Ω–æ–≤–Ω–æ–π –∞–∫—Ü–µ–Ω—Ç–Ω—ã–π (—Å–∏–Ω–∏–π)
    '#34c759',  // –∑–µ–ª–µ–Ω—ã–π
    '#ff9500',  // –æ—Ä–∞–Ω–∂–µ–≤—ã–π
    '#af52de',  // —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π
    '#ff3b30',  // –∫—Ä–∞—Å–Ω—ã–π
    '#5ac8fa',  // –≥–æ–ª—É–±–æ–π
    '#ffcc00',  // –∂–µ–ª—Ç—ã–π
    '#c5e1a5',  // —Å–≤–µ—Ç–ª—ã–π –∑–µ–ª–µ–Ω—ã–π
    '#80deea',  // –±–∏—Ä—é–∑–æ–≤—ã–π
    '#ff2d55'   // —Ä–æ–∑–æ–≤—ã–π
  ];
  return colors[i % colors.length];
}

// –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è donut —Å —Å–µ–≥–º–µ–Ω—Ç–∞–º–∏
function buildDonutSegments(parts) {
  const total = parts.reduce((s, p) => s + (Number(p.amount) || 0), 0) || 0;
  if (!total) return '';
  
  let accumulatedAngle = 0;
  const svgParts = [];
  
  for (let i = 0; i < parts.length; i++) {
    const p = parts[i];
    const amount = Number(p.amount) || 0;
    const percentage = amount / total;
    const angle = percentage * 360;
    
    // –°–æ–∑–¥–∞–µ–º –∫—Ä—É–≥–æ–≤–æ–π —Å–µ–≥–º–µ–Ω—Ç
    const startAngle = accumulatedAngle;
    const endAngle = startAngle + angle;
    
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —É–≥–ª—ã –≤ —Ä–∞–¥–∏–∞–Ω—ã
    const startRad = (startAngle - 90) * Math.PI / 180;
    const endRad = (endAngle - 90) * Math.PI / 180;
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –¥—É–≥–∏
    const radius = 70;
    const innerRadius = 30;
    
    const x1 = 70 + radius * Math.cos(startRad);
    const y1 = 70 + radius * Math.sin(startRad);
    const x2 = 70 + radius * Math.cos(endRad);
    const y2 = 70 + radius * Math.sin(endRad);
    
    const x3 = 70 + innerRadius * Math.cos(endRad);
    const y3 = 70 + innerRadius * Math.sin(endRad);
    const x4 = 70 + innerRadius * Math.cos(startRad);
    const y4 = 70 + innerRadius * Math.sin(startRad);
    
    const largeArcFlag = angle > 180 ? 1 : 0;
    
    const path = [
      `M ${x1} ${y1}`,
      `A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2}`,
      `L ${x3} ${y3}`,
      `A ${innerRadius} ${innerRadius} 0 ${largeArcFlag} 0 ${x4} ${y4}`,
      `Z`
    ].join(' ');
    
    // –ê–Ω–∏–º–∞—Ü–∏—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞
    const animationDelay = (i * 0.1) + 0.2;
    
    svgParts.push(
      `<path d="${path}" fill="${p.color}" stroke="var(--border)" stroke-width="1" class="segment-path" style="animation-delay: ${animationDelay}s;" />`
    );
    
    accumulatedAngle += angle;
  }
  
  return `
    <svg viewBox="0 0 140 140" class="donut-chart">
      ${svgParts.join('')}
    </svg>
  `;
}

function sparklineSvg(points){
  const w = 320, h = 64, pad = 6;
  const vals = (points || []).map(x => Number(x)||0);
  const max = Math.max(1, ...vals);
  const n = vals.length || 1;
  const step = (w - pad*2) / Math.max(1, n-1);

  const pts = vals.map((v, i) => {
    const x = pad + step * i;
    const y = (h - pad) - (v / max) * (h - pad*2);
    return `${x.toFixed(2)},${y.toFixed(2)}`;
  }).join(' ');

  const area = `${pad},${h-pad} ${pts} ${w-pad},${h-pad}`;

  return `
    <svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none" aria-label="–ì—Ä–∞—Ñ–∏–∫ —Ç—Ä–∞—Ç">
      <polyline points="${area}" fill="rgba(46,166,255,.10)" stroke="none" class="sparkline-fill"></polyline>
      <polyline points="${pts}" fill="none" stroke="var(--accent)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="sparkline-path"></polyline>
    </svg>
  `;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–ª–∞—Å—Å–∞ —Ü–≤–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—É–º–º—ã
function getExpenseColorClass(amount) {
  const numAmount = Number(amount) || 0;
  if (numAmount < 1000) return 'expense-low';
  if (numAmount < 5000) return 'expense-medium';
  return 'expense-high';
}

/* ======================================================
   –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô API FETCH - –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê JSON
====================================================== */
async function apiFetch(url, payload={}, opts={}){
  const method = (opts.method || 'POST').toUpperCase();
  const initData = tg?.initData || '';
  const userId = tg?.initDataUnsafe?.user?.id || '';

  const finalUrl = method === 'GET' ? buildUrl(url, {
    ...payload,
    telegram_user_id: userId
  }) : url;

  const headers = {
    'Authorization': initData,
    'X-Telegram-InitData': initData
  };

  if (method !== 'GET') {
    headers['Content-Type'] = 'application/json';
  }

  const options = {
    method,
    headers,
    body: method === 'GET' ? undefined : JSON.stringify({
      ...payload,
      initData,
      telegram_user_id: userId
    })
  };

  try {
    const res = await fetch(finalUrl, options);
    
    if (!res.ok) {
      // –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
      let errorText = 'Unknown error';
      try {
        errorText = await res.text();
      } catch (e) {
        // –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç
      }
      throw new Error(`HTTP ${res.status}: ${errorText || 'Request failed'}`);
    }

    // –í–ê–ñ–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–Ω–∞—á–∞–ª–∞ —á–∏—Ç–∞–µ–º –æ—Ç–≤–µ—Ç –∫–∞–∫ —Ç–µ–∫—Å—Ç
    const text = await res.text();
    
    // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –ø—É—Å—Ç–æ–π, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç
    if (!text || text.trim() === '') {
      console.warn('Empty response from API');
      return {};
    }
    
    // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ JSON
    try {
      return JSON.parse(text);
    } catch (jsonError) {
      console.warn('Response is not valid JSON, returning empty object. Text:', text.substring(0, 200));
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç –≤–º–µ—Å—Ç–æ –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞
      return {};
    }
  } catch (error) {
    console.error('API fetch error:', error);
    // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–∞–ª—å—à–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ UI
    throw error;
  }
}

/* ======================================================
   STATE
====================================================== */
let period = 'month';
let activeScreen = 'dashboard';

function periodButtons(){
  return `
    <div class="seg" role="tablist" aria-label="–ü–µ—Ä–∏–æ–¥">
      <button class="${period==='today'?'active':''}" onclick="setPeriod('today')">–°–µ–≥–æ–¥–Ω—è</button>
      <button class="${period==='week'?'active':''}" onclick="setPeriod('week')">–ù–µ–¥–µ–ª—è</button>
      <button class="${period==='month'?'active':''}" onclick="setPeriod('month')">–ú–µ—Å—è—Ü</button>
    </div>
  `;
}

function setPeriod(p){
  period = p;
  if (activeScreen === 'dashboard') showDashboard();
  else if (activeScreen === 'analytics') showAnalytics();
  else if (activeScreen === 'recent') showRecent();
}

/* ======================================================
   SCREEN: DASHBOARD (GET)
====================================================== */
async function showDashboard(){
  try {
    activeScreen = 'dashboard';
    setActiveTab(0);

    app.innerHTML = `
      <div class="topbar">
        <div class="app-title">–†–∞—Å—Ö–æ–¥—ã</div>
        ${periodButtons()}
      </div>
      ${loadingCard('–ó–∞–≥—Ä—É–∑–∫–∞...')}
    `;

    const params = {
      period,
      date: nowISODate(),
      month: monthKey()
    };

    const data = unwrapN8n(await apiFetch(API.DASHBOARD, params, { method: 'GET' }));
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ
    if (!data || Object.keys(data).length === 0) {
      throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç');
    }
    
    const currency = data.currency || '‚ÇΩ';
    const budgets = Array.isArray(data.budgets) ? data.budgets : [];
    const insight = data.insight || null;

    app.innerHTML = `
      <div class="topbar">
        <div class="app-title">–†–∞—Å—Ö–æ–¥—ã</div>
        ${periodButtons()}
      </div>

      <div class="card">
        <div class="label">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ (${period==='today'?'—Å–µ–≥–æ–¥–Ω—è':period==='week'?'–∑–∞ –Ω–µ–¥–µ–ª—é':'–∑–∞ –º–µ—Å—è—Ü'})</div>
        <div class="big">${fmtMoney(data.spent, currency)}</div>
        ${data.forecast !== undefined ? `<div class="sub">–ü—Ä–æ–≥–Ω–æ–∑: ${fmtMoney(data.forecast, currency)}</div>` : ''}
      </div>

      ${
        budgets.length ? `
        <div class="card">
          <div class="row">
            <div>
              <div style="font-size: 16px; font-weight: 700;">–ë—é–¥–∂–µ—Ç—ã</div>
              <div class="sub">–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ç—É—Å –ø–æ –ª–∏–º–∏—Ç–∞–º</div>
            </div>
            <span class="pill">–ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</span>
          </div>
          <div class="list">
            ${budgets.slice(0,5).map(b=>{
              const pct = b.percent ?? (b.limit ? Math.round((b.spent/b.limit)*100) : null);
              let cls = 'ok';
              if (pct >= 100) cls = 'bad';
              else if (pct >= 80) cls = 'warn';
              return `
                <div class="item">
                  <div class="left">
                    <div class="name">${escapeHtml(b.category_name || b.category || '–ö–∞—Ç–µ–≥–æ—Ä–∏—è')}</div>
                    <div class="meta">${fmtMoney(b.spent, currency)} –∏–∑ ${fmtMoney(b.limit, currency)}</div>
                  </div>
                  <div class="right">
                    <span class="pill ${cls}">${pct !== null ? (pct + '%') : '‚Äî'}</span>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
        ` : ''
      }

      ${
        insight?.text ? `
        <div class="card">
          <div class="row">
            <div>
              <div style="font-size: 16px; font-weight: 700;">–ò–Ω—Å–∞–π—Ç</div>
              <div class="sub">${escapeHtml(insight.text)}</div>
            </div>
            <span class="pill">${escapeHtml(insight.severity || 'info')}</span>
          </div>
        </div>
        ` : 
        (!budgets.length && (!data.spent || data.spent === 0)) ? `
        <div class="card">
          <div class="empty-state">
            <div class="empty-icon">üìä</div>
            <div class="empty-title">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
            <div class="empty-description">–ù–∞—á–Ω–∏—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å —Ç—Ä–∞—Ç—ã, —á—Ç–æ–±—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–≤–æ–∏ —Ä–∞—Å—Ö–æ–¥—ã</div>
          </div>
        </div>
        ` : ''
      }
    `;
  } catch (e){
    app.innerHTML = `
      <div class="topbar">
        <div class="app-title">–†–∞—Å—Ö–æ–¥—ã</div>
        ${periodButtons()}
      </div>
      <div class="card">
        <div style="font-size: 16px; font-weight: 700;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
        <div class="sub">${escapeHtml(String(e.message || e))}</div>
        <div class="divider"></div>
        <button class="btn" onclick="showDashboard()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
      </div>
    `;
    tg?.HapticFeedback?.notificationOccurred('error');
  }
}

/* ======================================================
   SCREEN: ANALYTICS (GET)
====================================================== */
async function showAnalytics(){
  try {
    activeScreen = 'analytics';
    setActiveTab(1);

    app.innerHTML = `
      <div class="topbar">
        <div class="app-title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
        ${periodButtons()}
      </div>
      ${loadingCard('–ó–∞–≥—Ä—É–∑–∫–∞...')}
    `;

    const raw = await apiFetch(API.ANALYTICS, { 
      period, 
      date: nowISODate(), 
      month: monthKey() 
    }, { 
      method: 'GET' 
    });
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ
    if (!raw || Object.keys(raw).length === 0) {
      throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç');
    }
    
    const data = unwrapN8n(raw);
    const currency = data.currency || '‚ÇΩ';
    const catsRaw = Array.isArray(data.categories) ? data.categories : [];
    const timeline = Array.isArray(data.timeline) ? data.timeline : [];
    const topExpenses = Array.isArray(data.top_expenses) ? data.top_expenses : [];

    const total = Number(data.total) || catsRaw.reduce((s,c)=> s + (Number(c.amount)||0), 0) || 0;
    const prevTotal = (data.prev_total !== undefined && data.prev_total !== null) ? Number(data.prev_total) : null;

    const catsSorted = catsRaw
      .map(c => ({ 
        name: String(c.name || c.category_name || '').trim() || '–ö–∞—Ç–µ–≥–æ—Ä–∏—è', 
        amount: Number(c.amount)||0 
      }))
      .filter(c => c.amount > 0)
      .sort((a,b)=> b.amount - a.amount);

    const topN = 5;
    const catsTop = catsSorted.slice(0, topN);
    const restSum = catsSorted.slice(topN).reduce((s,c)=> s + c.amount, 0);
    if (restSum > 0) catsTop.push({ name: '–ø—Ä–æ—á–µ–µ', amount: restSum });

    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç–∞ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
    const donutParts = catsTop.map((c, i) => ({ 
      ...c, 
      color: colorForIndex(i) 
    }));

    let delta = null, deltaPct = null;
    if (prevTotal !== null && !Number.isNaN(prevTotal)){
      delta = total - prevTotal;
      if (prevTotal > 0) {
        deltaPct = Math.round((delta / prevTotal) * 100);
      } else {
        deltaPct = total > 0 ? 100 : 0;
      }
    }

    const points = timeline.map(t => Number(t.amount)||0);
    const spark = (timeline.length >= 2) ? sparklineSvg(points) : '';

    app.innerHTML = `
      <div class="topbar">
        <div class="app-title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
        ${periodButtons()}
      </div>

      <div class="card">
        <div class="label">–ò—Ç–æ–≥–æ ‚Ä¢ ${labelForPeriod(period).toLowerCase()}</div>
        <div class="big">${fmtMoney(total, currency)}</div>

        ${
          (prevTotal !== null && !Number.isNaN(prevTotal)) ? `
          <div class="kpi-row">
            <div class="kpi">
              <div class="k">–ü—Ä–æ—à–ª—ã–π –ø–µ—Ä–∏–æ–¥</div>
              <div class="v">${fmtMoney(prevTotal, currency)}</div>
            </div>
            <div class="kpi">
              <div class="k">–ò–∑–º–µ–Ω–µ–Ω–∏–µ</div>
              <div class="v">
                ${delta >= 0 ? '+' : ''}${fmtMoney(delta, currency)}
                ${deltaPct !== null ? `<span class="delta-pill ${delta > 0 ? 'warn' : (delta < 0 ? 'ok' : '')}">${deltaPct >= 0 ? '+' : ''}${deltaPct}%</span>` : ''}
              </div>
            </div>
          </div>` : ''
        }

        ${
          total > 0 && donutParts.length ? `
          <div class="donut-wrap">
            <div class="donut">
              ${buildDonutSegments(donutParts)}
              <div class="donut-center">
                <div class="t">${fmtMoney(total, currency)}</div>
                <div class="s">—Å—Ç—Ä—É–∫—Ç—É—Ä–∞</div>
              </div>
            </div>

            <div class="legend">
              ${donutParts.map((c,i)=>{
                const pct = total ? Math.round((c.amount / total) * 100) : 0;
                return `
                  <div class="lg-item">
                    <div class="lg-left">
                      <div class="lg-name">
                        <span class="sw" style="background:${c.color}"></span>
                        <span>${escapeHtml(c.name)}</span>
                      </div>
                      <div class="lg-meta">${pct}%</div>
                    </div>
                    <div class="lg-right">
                      <div class="lg-amt">${fmtMoney(c.amount, currency)}</div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>` : 
          total === 0 ? `
          <div class="empty-state" style="padding: 20px 0;">
            <div class="empty-icon">üìà</div>
            <div class="empty-title">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
            <div class="empty-description">–î–æ–±–∞–≤—å—Ç–µ —Ç—Ä–∞—Ç—ã –∑–∞ ${labelForPeriod(period).toLowerCase()}, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</div>
          </div>
          ` : ''
        }

        ${
          spark ? `
          <div class="spark">
            <div class="cap">
              <div class="label">–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –¥–Ω—è–º</div>
              <span class="pill">spark</span>
            </div>
            ${spark}
          </div>` : ''
        }
      </div>

      ${
        topExpenses.length ? `
        <div class="card">
          <div class="row">
            <div>
              <div style="font-size: 16px; font-weight: 700;">–ö—Ä—É–ø–Ω—ã–µ —Ç—Ä–∞—Ç—ã</div>
              <div class="sub">–ß—Ç–æ —Å–∏–ª—å–Ω–µ–µ –≤—Å–µ–≥–æ –¥–≤–∏–≥–∞–µ—Ç —Å—É–º–º—É</div>
            </div>
            <span class="pill">${topExpenses.slice(0,5).length} —à—Ç</span>
          </div>

          <div class="list">
            ${topExpenses.slice(0,5).map(x=>{
              const name = escapeHtml(x.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è');
              const cat = escapeHtml(x.category_name || x.category || '');
              const dt = escapeHtml(x.date || x.created_at || '');
              const colorClass = getExpenseColorClass(x.amount);
              return `
                <div class="item">
                  <div class="left">
                    <div class="name">${name}</div>
                    <div class="meta">${[cat, dt].filter(Boolean).join(' ‚Ä¢ ')}</div>
                  </div>
                  <div class="right">
                    <div class="amt ${colorClass}">${fmtMoney(x.amount, currency)}</div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>` : 
        total > 0 ? `
        <div class="card">
          <div class="empty-state" style="padding: 20px 0;">
            <div class="empty-icon">üí∞</div>
            <div class="empty-title">–ù–µ—Ç –∫—Ä—É–ø–Ω—ã—Ö —Ç—Ä–∞—Ç</div>
            <div class="empty-description">–í—Å–µ –≤–∞—à–∏ —Ä–∞—Å—Ö–æ–¥—ã —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã</div>
          </div>
        </div>
        ` : ''
      }
    `;
  } catch(e){
    app.innerHTML = `
      <div class="topbar">
        <div class="app-title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
        ${periodButtons()}
      </div>
      <div class="card">
        <div style="font-size: 16px; font-weight: 700;">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</div>
        <div class="sub">${escapeHtml(String(e.message || e))}</div>
        <div class="divider"></div>
        <button class="btn" onclick="showAnalytics()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
      </div>
    `;
  }
}

/* ======================================================
   –î–û–ë–ê–í–õ–ï–ù–ò–ï –¢–†–ê–¢–´ –ß–ï–†–ï–ó –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û
====================================================== */
async function submitExpenseModal(){
  const amount = document.getElementById('modalAmount')?.value;
  const description = document.getElementById('modalDescription')?.value || '';
  const dateStr = document.getElementById('modalDate')?.value || nowISODate();

  if (!amount || Number(amount) <= 0){
    tg?.showAlert('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É');
    return;
  }

  try{
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –≤ —Ç—Ä–µ–±—É–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç: 2026-01-06T19:25:45.844027
    const now = new Date();
    const selectedDate = new Date(dateStr);
    
    // –°–æ–∑–¥–∞–µ–º –¥–∞—Ç—É —Å –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç–æ–π –∏ —Ç–µ–∫—É—â–∏–º –≤—Ä–µ–º–µ–Ω–µ–º
    const finalDate = new Date(
      selectedDate.getFullYear(),
      selectedDate.getMonth(),
      selectedDate.getDate(),
      now.getHours(),
      now.getMinutes(),
      now.getSeconds(),
      now.getMilliseconds()
    );
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤ ISO —Å—Ç—Ä–æ–∫—É –∏ –¥–æ–±–∞–≤–ª—è–µ–º –º–∏–∫—Ä–æ—Å–µ–∫—É–Ω–¥—ã
    const isoString = finalDate.toISOString();
    // –ó–∞–º–µ–Ω—è–µ–º 'Z' –Ω–∞ –º–∏–∫—Ä–æ—Å–µ–∫—É–Ω–¥—ã (6 —Ü–∏—Ñ—Ä)
    const dateFormatted = isoString.replace('Z', 
      String(finalDate.getMilliseconds()).padStart(3, '0') + '000'
    ).replace('.000Z', '.000000');

    await apiFetch(API.ADD_EXPENSE, { 
      amount: Number(amount), 
      description, 
      date: dateFormatted
    }, { 
      method: 'POST' 
    });

    tg?.HapticFeedback?.notificationOccurred('success');
    
    if (tg?.showPopup) {
      tg.showPopup({
        title: '–ì–æ—Ç–æ–≤–æ',
        message: '–¢—Ä–∞—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞',
        buttons: [{ type: 'ok' }]
      });
    } else {
      alert('–¢—Ä–∞—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
    }

    closeAddModal();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —ç–∫—Ä–∞–Ω
    if (activeScreen === 'dashboard') showDashboard();
    else if (activeScreen === 'analytics') showAnalytics();
    else if (activeScreen === 'recent') showRecent();
  } catch(e){
    tg?.HapticFeedback?.notificationOccurred('error');
    tg?.showAlert(`–û—à–∏–±–∫–∞: ${String(e.message || e)}`);
  }
}

/* ======================================================
   SCREEN: RECENT
====================================================== */
async function showRecent(){
  try {
    activeScreen = 'recent';
    setActiveTab(2);

    app.innerHTML = `
      <div class="topbar">
        <div class="app-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞—Ç—ã</div>
        ${periodButtons()}
      </div>
      ${loadingCard('–ó–∞–≥—Ä—É–∑–∫–∞...')}
    `;

    const data = unwrapN8n(await apiFetch(API.RECENT, { 
      period, 
      date: nowISODate(), 
      month: monthKey(), 
      limit: 25 
    }, { 
      method: 'POST' 
    }));
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ
    if (!data || Object.keys(data).length === 0) {
      throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç');
    }
    
    const currency = data.currency || '‚ÇΩ';
    const items = Array.isArray(data.expenses) ? data.expenses : (Array.isArray(data) ? data : []);

    app.innerHTML = `
      <div class="topbar">
        <div class="app-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞—Ç—ã</div>
        ${periodButtons()}
      </div>

      <div class="card">
        <div class="row">
          <div>
            <div style="font-size: 16px; font-weight: 700;">–°–ø–∏—Å–æ–∫</div>
            <div class="sub">–ë—ã—Å—Ç—Ä–æ —É–¥–∞–ª–∏—Ç—å / –ø—Ä–æ–≤–µ—Ä–∏—Ç—å</div>
          </div>
          <span class="pill">${items.length} —à—Ç</span>
        </div>

        <div class="list">
          ${
            items.length ? items.map(x=>{
              const id = x.id || x.expense_id || '';
              const name = x.description || x.comment || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è';
              const cat = x.category || x.category_name || '';
              const dt = x.date || x.created_at || '';
              const safeId = escapeHtml(id);
              const safeName = escapeHtml(name);
              const safeCat = escapeHtml(cat);
              const safeDt = escapeHtml(dt);
              const colorClass = getExpenseColorClass(x.amount);
              
              return `
                <div class="item">
                  <div class="left">
                    <div class="name">${safeName}</div>
                    <div class="meta">${[safeCat, safeDt].filter(Boolean).join(' ‚Ä¢ ')}</div>
                  </div>
                  <div class="right">
                    <div class="amt ${colorClass}">${fmtMoney(x.amount, currency)}</div>
                    ${id ? `<button class="mini-btn danger" onclick="deleteExpense('${safeId}')">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
                  </div>
                </div>
              `;
            }).join('') : 
            `
            <div class="empty-state" style="padding: 20px 0;">
              <div class="empty-icon">üìù</div>
              <div class="empty-title">–ü–æ–∫–∞ –Ω–µ—Ç —Ç—Ä–∞—Ç</div>
              <div class="empty-description">–ù–∞–∂–º–∏—Ç–µ "+" —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é —Ç—Ä–∞—Ç—É</div>
            </div>
            `
          }
        </div>
      </div>
    `;
  } catch(e){
    app.innerHTML = `
      <div class="topbar">
        <div class="app-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞—Ç—ã</div>
        ${periodButtons()}
      </div>
      <div class="card">
        <div style="font-size: 16px; font-weight: 700;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å</div>
        <div class="sub">${escapeHtml(String(e.message || e))}</div>
        <button class="btn" onclick="showRecent()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
      </div>
    `;
  }
}

async function deleteExpense(id){
  if (!id) return;

  const confirmDelete = () => {
    return new Promise((resolve) => {
      if (tg?.showPopup) {
        tg.showPopup({
          title: '–£–¥–∞–ª–∏—Ç—å?',
          message: '–¢—Ä–∞—Ç–∞ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞',
          buttons: [
            { id: 'cancel', type: 'cancel', text: '–û—Ç–º–µ–Ω–∞' },
            { id: 'ok', type: 'destructive', text: '–£–¥–∞–ª–∏—Ç—å' }
          ]
        }, (btnId) => {
          resolve(btnId === 'ok');
        });
      } else {
        resolve(confirm('–£–¥–∞–ª–∏—Ç—å —Ç—Ä–∞—Ç—É?'));
      }
    });
  };

  const shouldDelete = await confirmDelete();
  if (!shouldDelete) return;
  
  try {
    await apiFetch(API.DELETE_EXPENSE, { id }, { method: 'POST' });
    tg?.HapticFeedback?.notificationOccurred('success');
    showRecent();
  } catch(e) {
    tg?.HapticFeedback?.notificationOccurred('error');
    tg?.showAlert(`–û—à–∏–±–∫–∞: ${String(e.message || e)}`);
  }
}

/* ======================================================
   INIT
====================================================== */
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Pull-to-Refresh
document.addEventListener('DOMContentLoaded', () => {
  initPullToRefreshFallback();
});

// –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
try {
  showDashboard();
} catch (e) {
  app.innerHTML = `
    <div class="card">
      <div style="font-size: 16px; font-weight: 700;">–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞</div>
      <div class="sub">${escapeHtml(String(e.message || e))}</div>
      <button class="btn" onclick="showDashboard()">–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å</button>
    </div>
  `;
  console.error('App initialization error:', e);
}
</script>
</body>
</html>
