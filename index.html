<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Expenses Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg: #0b0b0f;
      --card: #1c1c1e;
      --muted: rgba(255,255,255,.65);
      --text: #ffffff;
      --border: rgba(255,255,255,.08);
      --accent: #2ea6ff;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --radius: 16px;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .wrap { padding: 14px 14px 88px; }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin: 6px 0 12px;
    }
    .app-title{
      font-weight: 700;
      font-size: 18px;
      letter-spacing: .2px;
    }

    .seg{
      display:flex;
      gap:6px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--border);
      padding: 6px;
      border-radius: 999px;
    }
    .seg button{
      border:0;
      background: transparent;
      color: var(--muted);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 13px;
      cursor:pointer;
    }
    .seg button.active{
      background: rgba(255,255,255,.10);
      color: var(--text);
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
      margin-bottom: 10px;
    }

    .row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }
    .label{
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 6px;
    }
    .title{
      font-weight: 700;
      font-size: 16px;
    }
    .big{
      font-size: 28px;
      font-weight: 800;
      letter-spacing: .2px;
      line-height: 1.1;
    }
    .sub{
      color: var(--muted);
      font-size: 13px;
      margin-top: 6px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border:1px solid var(--border);
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
    }
    .pill.warn{ color: #ffd479; }
    .pill.ok{ color: #8cffb1; }
    .pill.bad{ color: #ff8c8c; }

    .list{ margin-top: 6px; }
    .item{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding: 10px 0;
      border-top: 1px solid var(--border);
    }
    .item:first-child{ border-top: 0; }
    .item .left{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 0;
    }
    .item .name{
      font-size: 14px;
      font-weight: 600;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 230px;
    }
    .item .meta{
      color: var(--muted);
      font-size: 12px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .item .right{
      text-align:right;
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-end;
    }
    .amt{
      font-weight: 800;
      font-size: 14px;
    }
    .mini-btn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 12px;
      cursor:pointer;
    }
    .mini-btn.danger{ color: #ff9a9a; }

    .btn{
      width: 100%;
      border:0;
      background: var(--accent);
      color: #001018;
      font-weight: 800;
      padding: 14px 14px;
      border-radius: 14px;
      cursor:pointer;
      font-size: 16px;
      margin-top: 10px;
    }

    .input{
      width: 100%;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 16px;
      outline: none;
      box-sizing: border-box;
    }
    .input::placeholder{ color: rgba(255,255,255,.35); }

    .nav{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      background: rgba(18,18,22,.92);
      backdrop-filter: blur(14px);
      border-top: 1px solid var(--border);
      display:flex;
      gap: 8px;
    }
    .nav button{
      flex: 1;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      padding: 10px 8px;
      border-radius: 14px;
      font-size: 13px;
      cursor:pointer;
    }
    .nav button.active{
      color: var(--text);
      border-color: rgba(46,166,255,.35);
      background: rgba(46,166,255,.14);
    }

    .loading{
      display:flex; gap:10px; align-items:center; color: var(--muted);
    }
    .dot{
      width: 8px; height: 8px; border-radius: 50%;
      background: rgba(255,255,255,.25);
      animation: pulse 1s infinite ease-in-out;
    }
    .dot:nth-child(2){ animation-delay: .15s; }
    .dot:nth-child(3){ animation-delay: .3s; }
    @keyframes pulse{
      0%,100%{ transform: scale(1); opacity: .5; }
      50%{ transform: scale(1.35); opacity: 1; }
    }
  
    .kpi-row{ display:flex; gap:10px; margin-top:10px; }
    .kpi{ flex:1; background: rgba(255,255,255,.04); border:1px solid var(--border); border-radius: 14px; padding: 10px; }
    .kpi .k{ color: var(--muted); font-size: 12px; margin-bottom: 4px; }
    .kpi .v{ font-weight: 800; font-size: 15px; }

    .donut-wrap{ display:flex; gap:14px; align-items:center; margin-top: 10px; }
    .donut{
      width: 140px; height: 140px;
      border-radius: 50%;
      background: conic-gradient(from -90deg, rgba(255,255,255,.12) 0 360deg);
      position: relative;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      flex: 0 0 auto;
    }
    .donut::after{
      content:'';
      position:absolute;
      inset: 22%;
      border-radius: 50%;
      background: var(--card);
      border: 1px solid var(--border);
    }
    .donut-center{
      position:absolute;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      z-index: 2;
      text-align:center;
      padding: 10px;
      pointer-events:none;
    }
    .donut-center .t{ font-weight: 900; font-size: 14px; }
    .donut-center .s{ color: var(--muted); font-size: 11px; margin-top: 4px; }

    .legend{ flex: 1; min-width: 0; }
    .legend .lg-item{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; padding: 8px 0; border-top:1px solid var(--border); }
    .legend .lg-item:first-child{ border-top:0; padding-top:0; }
    .lg-left{ display:flex; flex-direction:column; gap:3px; min-width: 0; }
    .lg-name{ display:flex; align-items:center; gap:8px; font-weight: 650; font-size: 14px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .sw{ width:10px; height:10px; border-radius: 3px; flex:0 0 auto; margin-top: 3px; }
    .lg-meta{ color: var(--muted); font-size: 12px; }
    .lg-right{ text-align:right; display:flex; flex-direction:column; gap:4px; align-items:flex-end; }
    .lg-amt{ font-weight: 900; font-size: 13px; white-space:nowrap; }

    .divider{
      height: 1px;
      background: var(--border);
      margin: 10px 0;
    }

  </style>
</head>

<body>
  <div id="app" class="wrap"></div>

  <div class="nav">
    <button id="tab0" onclick="showDashboard()" class="active">üè† –°–µ–π—á–∞—Å</button>
    <button id="tab1" onclick="showAnalytics()">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
    <button id="tab2" onclick="showAdd()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
    <button id="tab3" onclick="showRecent()">üßæ –¢—Ä–∞—Ç—ã</button>
  </div>

<script>
/* TELEGRAM INIT */
const tg = window.Telegram?.WebApp;
if (tg) {
  tg.expand();
  tg.ready();
}

/* API CONFIG - –ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ô N8N URL */
const N8N_BASE = 'https://n8n.todobotmy.ru/webhook';

const API = {
  DASHBOARD: `${N8N_BASE}/fin-dashboard`,
  ANALYTICS: `${N8N_BASE}/fin-analytics`,
  RECENT: `${N8N_BASE}/fin-expenses-recent`,
  ADD_EXPENSE: `${N8N_BASE}/fin-expenses-add`,
  DELETE_EXPENSE: `${N8N_BASE}/fin-expenses-delete`
};

const app = document.getElementById('app');

/* HELPERS */
function setActiveTab(i){
  for (let k=0;k<4;k++){
    const btn = document.getElementById('tab'+k);
    if (btn) btn.classList.toggle('active', k===i);
  }
}

function fmtMoney(n, currency='‚ÇΩ'){
  if (n === null || n === undefined || n === '') return '‚Äî';
  const num = Number(n);
  if (Number.isNaN(num)) return String(n);
  return new Intl.NumberFormat('ru-RU').format(num) + ' ' + currency;
}

function nowISODate(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}

function monthKey(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  return `${yyyy}-${mm}`;
}

function loadingCard(text='–ó–∞–≥—Ä—É–∑–∫–∞'){
  return `
    <div class="card">
      <div class="loading">
        <span>${text}</span>
        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
      </div>
    </div>
  `;
}

function escapeHtml(str){
  const s = String(str ?? '');
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

function unwrapN8n(x){
  if (Array.isArray(x)) return x[0] ?? {};
  return x ?? {};
}

function colorForIndex(i){
  const hue = (i * 57) % 360;
  return `hsl(${hue} 70% 55%)`;
}

function buildDonutGradient(parts){
  const total = parts.reduce((s,p)=>s + (Number(p.amount)||0), 0) || 0;
  if (!total) return `conic-gradient(from -90deg, rgba(255,255,255,.12) 0 360deg)`;
  let acc = 0;
  const stops = parts.map(p=>{
    const a = Number(p.amount)||0;
    const start = acc;
    const deg = (a / total) * 360;
    acc += deg;
    return `${p.color} ${start.toFixed(2)}deg ${acc.toFixed(2)}deg`;
  });
  return `conic-gradient(from -90deg, ${stops.join(',')})`;
}

async function apiFetch(url, payload={}, opts={}){
  const initData = tg?.initData || '';
  const method = (opts.method || 'GET').toUpperCase();
  
  const userId = tg?.initDataUnsafe?.user?.id;

  let finalUrl = url;
  let body = undefined;

  if (method === 'GET') {
    const u = new URL(url);
    Object.entries(payload).forEach(([k,v]) => {
      if (v !== undefined && v !== null && v !== '') u.searchParams.set(k, String(v));
    });
    if (userId) u.searchParams.set('telegram_user_id', userId);
    finalUrl = u.toString();
  } else {
    body = JSON.stringify({
      ...payload,
      telegram_user_id: userId
    });
  }

  const res = await fetch(finalUrl, {
    method,
    headers: {
      ...(method === 'GET' ? {} : { 'Content-Type': 'application/json' }),
      'Authorization': initData,
      'X-Telegram-InitData': initData
    },
    body
  });

  if (!res.ok) {
    const t = await res.text().catch(()=> '');
    throw new Error(`HTTP ${res.status}: ${t || 'Request failed'}`);
  }

  const ct = res.headers.get('content-type') || '';
  if (ct.includes('application/json')) return await res.json();
  const text = await res.text();
  try { return JSON.parse(text); } catch { return { raw: text }; }
}

/* STATE */
let period = 'month';
let activeScreen = 'dashboard';

function periodButtons(){
  return `
    <div class="seg">
      <button class="${period==='today'?'active':''}" onclick="setPeriod('today')">–°–µ–≥–æ–¥–Ω—è</button>
      <button class="${period==='week'?'active':''}" onclick="setPeriod('week')">–ù–µ–¥–µ–ª—è</button>
      <button class="${period==='month'?'active':''}" onclick="setPeriod('month')">–ú–µ—Å—è—Ü</button>
    </div>
  `;
}

function setPeriod(p){
  period = p;
  if (activeScreen === 'dashboard') showDashboard();
  if (activeScreen === 'analytics') showAnalytics();
  if (activeScreen === 'recent') showRecent();
}

/* DASHBOARD */
async function showDashboard(){
  activeScreen = 'dashboard';
  setActiveTab(0);

  app.innerHTML = `
    <div class="topbar">
      <div class="app-title">–†–∞—Å—Ö–æ–¥—ã</div>
      ${periodButtons()}
    </div>
    ${loadingCard('–ó–∞–≥—Ä—É–∑–∫–∞...')}
  `;

  try {
    const params = {
      period,
      date: nowISODate(),
      month: monthKey()
    };

    const data = unwrapN8n(await apiFetch(API.DASHBOARD, params, { method: 'GET' }));

    const currency = data.currency || '‚ÇΩ';
    const spent = Number(data.spent) || 0;

    app.innerHTML = `
      <div class="topbar">
        <div class="app-title">–†–∞—Å—Ö–æ–¥—ã</div>
        ${periodButtons()}
      </div>

      <div class="card">
        <div class="label">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
        <div class="big">${fmtMoney(spent, currency)}</div>
        ${data.forecast ? `<div class="sub">–ü—Ä–æ–≥–Ω–æ–∑: ${fmtMoney(data.forecast, currency)}</div>` : ''}
      </div>

      <div class="card">
        <div class="title">–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</div>
        <div class="sub">–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å n8n webhooks</div>
      </div>
    `;
  } catch (e){
    console.error('Dashboard error:', e);
    app.innerHTML = `
      <div class="topbar">
        <div class="app-title">–†–∞—Å—Ö–æ–¥—ã</div>
        ${periodButtons()}
      </div>
      <div class="card">
        <div class="title">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
        <div class="sub">${escapeHtml(String(e.message || e))}</div>
        <button class="btn" onclick="showDashboard()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
      </div>
    `;
  }
}

/* ANALYTICS */
async function showAnalytics(){
  activeScreen = 'analytics';
  setActiveTab(1);

  app.innerHTML = `
    <div class="topbar">
      <div class="app-title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
      ${periodButtons()}
    </div>
    ${loadingCard('–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏...')}
  `;

  try{
    const data = unwrapN8n(await apiFetch(API.ANALYTICS, { period, date: nowISODate(), month: monthKey() }, { method: 'GET' }));

    const currency = data.currency || '‚ÇΩ';
    const total = Number(data.total) || 0;

    app.innerHTML = `
      <div class="topbar">
        <div class="app-title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
        ${periodButtons()}
      </div>

      <div class="card">
        <div class="label">–ò—Ç–æ–≥–æ –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
        <div class="big">${fmtMoney(total, currency)}</div>
        <div class="sub">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</div>
      </div>
    `;
  } catch(e){
    console.error('Analytics error:', e);
    app.innerHTML = `
      <div class="card">
        <div class="title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</div>
        <div class="sub">${escapeHtml(String(e.message || e))}</div>
        <button class="btn" onclick="showAnalytics()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
      </div>
    `;
  }
}

/* ADD EXPENSE */
function showAdd(){
  activeScreen = 'add';
  setActiveTab(2);

  const today = nowISODate();

  app.innerHTML = `
    <div class="topbar">
      <div class="app-title">–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞—Ç—É</div>
    </div>

    <div class="card">
      <div class="label">–°—É–º–º–∞</div>
      <input class="input" id="amount" type="number" inputmode="decimal" placeholder="350" />

      <div class="label" style="margin-top:10px;">–û–ø–∏—Å–∞–Ω–∏–µ</div>
      <input class="input" id="description" placeholder="–∫–æ—Ñ–µ, —Ç–∞–∫—Å–∏, –ø—Ä–æ–¥—É–∫—Ç—ã..." />

      <div class="label" style="margin-top:10px;">–î–∞—Ç–∞</div>
      <input class="input" id="date" type="date" value="${today}" />

      <button class="btn" onclick="submitExpense()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  `;
}

async function submitExpense(){
  const amount = document.getElementById('amount').value;
  const description = document.getElementById('description').value || '';
  const date = document.getElementById('date').value || nowISODate();

  if (!amount || Number(amount) <= 0){
    if (tg) tg.showAlert('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É');
    else alert('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É');
    return;
  }

  try{
    await apiFetch(API.ADD_EXPENSE, { amount: Number(amount), description, date }, { method: 'POST' });

    if (tg) {
      tg.HapticFeedback?.notificationOccurred('success');
      tg.showPopup({
        title: '–ì–æ—Ç–æ–≤–æ',
        message: '–¢—Ä–∞—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞',
        buttons: [{ type: 'ok' }]
      });
    } else {
      alert('–¢—Ä–∞—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
    }

    showDashboard();
  } catch(e){
    console.error('Submit error:', e);
    if (tg) {
      tg.HapticFeedback?.notificationOccurred('error');
      tg.showAlert(`–û—à–∏–±–∫–∞: ${String(e.message || e)}`);
    } else {
      alert(`–û—à–∏–±–∫–∞: ${String(e.message || e)}`);
    }
  }
}

/* RECENT */
async function showRecent(){
  activeScreen = 'recent';
  setActiveTab(3);

  app.innerHTML = `
    <div class="topbar">
      <div class="app-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞—Ç—ã</div>
      ${periodButtons()}
    </div>
    ${loadingCard('–ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞—Ç...')}
  `;

  try{
    const data = unwrapN8n(await apiFetch(API.RECENT, { period, date: nowISODate(), month: monthKey(), limit: 25 }, { method: 'GET' }));
    const currency = data.currency || '‚ÇΩ';
    const items = Array.isArray(data.expenses) ? data.expenses : (Array.isArray(data) ? data : []);

    app.innerHTML = `
      <div class="topbar">
        <div class="app-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞—Ç—ã</div>
        ${periodButtons()}
      </div>

      <div class="card">
        <div class="row">
          <div>
            <div class="title">–°–ø–∏—Å–æ–∫</div>
            <div class="sub">–í–∞—à–∏ —Ç—Ä–∞—Ç—ã –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
          </div>
          <span class="pill">${items.length} —à—Ç</span>
        </div>

        <div class="list">
          ${
            items.length ? items.map(x=>{
              const id = x.id || x.expense_id || '';
              const name = escapeHtml(x.description || x.comment || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è');
              const cat = escapeHtml(x.category || x.category_name || '');
              const dt = escapeHtml(x.date || x.created_at || '');
              return `
                <div class="item">
                  <div class="left">
                    <div class="name">${name}</div>
                    <div class="meta">${[cat, dt].filter(Boolean).join(' ‚Ä¢ ')}</div>
                  </div>
                  <div class="right">
                    <div class="amt">${fmtMoney(x.amount, currency)}</div>
                    ${id ? `<button class="mini-btn danger" onclick="deleteExpense('${id}')">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
                  </div>
                </div>
              `;
            }).join('') : `<div class="sub">–ü–æ–∫–∞ –ø—É—Å—Ç–æ.</div>`
          }
        </div>
      </div>
    `;
  } catch(e){
    console.error('Recent error:', e);
    app.innerHTML = `
      <div class="card">
        <div class="title">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å</div>
        <div class="sub">${escapeHtml(String(e.message || e))}</div>
        <button class="btn" onclick="showRecent()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
      </div>
    `;
  }
}

async function deleteExpense(id){
  if (!id) return;

  const confirmed = tg 
    ? await new Promise(resolve => {
        tg.showPopup({
          title: '–£–¥–∞–ª–∏—Ç—å?',
          message: '–¢—Ä–∞—Ç–∞ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞',
          buttons: [
            { id: 'cancel', type: 'cancel', text: '–û—Ç–º–µ–Ω–∞' },
            { id: 'ok', type: 'destructive', text: '–£–¥–∞–ª–∏—Ç—å' }
          ]
        }, btnId => resolve(btnId === 'ok'));
      })
    : confirm('–£–¥–∞–ª–∏—Ç—å —Ç—Ä–∞—Ç—É?');

  if (!confirmed) return;

  try{
    await apiFetch(API.DELETE_EXPENSE, { id }, { method: 'POST' });
    if (tg) tg.HapticFeedback?.notificationOccurred('success');
    showRecent();
  } catch(e){
    console.error('Delete error:', e);
    if (tg) {
      tg.HapticFeedback?.notificationOccurred('error');
      tg.showAlert(`–û—à–∏–±–∫–∞: ${String(e.message || e)}`);
    } else {
      alert(`–û—à–∏–±–∫–∞: ${String(e.message || e)}`);
    }
  }
}

/* INIT */
showDashboard();
</script>
</body>
</html>
