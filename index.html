<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Expenses Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg: #0b0b0f;
      --card: #1c1c1e;
      --muted: rgba(255,255,255,.65);
      --text: #ffffff;
      --border: rgba(255,255,255,.08);
      --accent: #2ea6ff;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --radius: 16px;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .wrap { padding: 14px 14px 88px; }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin: 6px 0 12px;
    }
    .app-title{
      font-weight: 700;
      font-size: 18px;
      letter-spacing: .2px;
    }

    .seg{
      display:flex;
      gap:6px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--border);
      padding: 6px;
      border-radius: 999px;
    }
    .seg button{
      border:0;
      background: transparent;
      color: var(--muted);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 13px;
      cursor:pointer;
    }
    .seg button.active{
      background: rgba(255,255,255,.10);
      color: var(--text);
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
      margin-bottom: 10px;
    }

    .row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }
    .label{
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 6px;
    }
    .big{
      font-size: 28px;
      font-weight: 800;
      letter-spacing: .2px;
      line-height: 1.1;
    }
    .sub{
      color: var(--muted);
      font-size: 13px;
      margin-top: 6px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border:1px solid var(--border);
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
    }
    .pill.warn{ color: #ffd479; }
    .pill.ok{ color: #8cffb1; }
    .pill.bad{ color: #ff8c8c; }

    .list{ margin-top: 6px; }
    .item{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding: 10px 0;
      border-top: 1px solid var(--border);
    }
    .item:first-child{ border-top: 0; }
    .item .left{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 0;
    }
    .item .name{
      font-size: 14px;
      font-weight: 600;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 230px;
    }
    .item .meta{
      color: var(--muted);
      font-size: 12px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .item .right{
      text-align:right;
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-end;
    }
    .amt{
      font-weight: 800;
      font-size: 14px;
    }
    .mini-btn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 12px;
      cursor:pointer;
    }
    .mini-btn.danger{ color: #ff9a9a; }

    .btn{
      width: 100%;
      border:0;
      background: var(--accent);
      color: #001018;
      font-weight: 800;
      padding: 14px 14px;
      border-radius: 14px;
      cursor:pointer;
      font-size: 16px;
      margin-top: 10px;
    }

    .input{
      width: 100%;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 16px;
      outline: none;
    }
    .input::placeholder{ color: rgba(255,255,255,.35); }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .nav{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      background: rgba(18,18,22,.92);
      backdrop-filter: blur(14px);
      border-top: 1px solid var(--border);
      display:flex;
      gap: 8px;
    }
    .nav button{
      flex: 1;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      padding: 10px 8px;
      border-radius: 14px;
      font-size: 13px;
      cursor:pointer;
    }
    .nav button.active{
      color: var(--text);
      border-color: rgba(46,166,255,.35);
      background: rgba(46,166,255,.14);
    }

    .hint{
      color: rgba(255,255,255,.45);
      font-size: 12px;
      margin-top: 8px;
      line-height: 1.35;
    }

    .divider{
      height: 1px;
      background: var(--border);
      margin: 10px 0;
    }

    .loading{
      display:flex; gap:10px; align-items:center; color: var(--muted);
    }
    .dot{
      width: 8px; height: 8px; border-radius: 50%;
      background: rgba(255,255,255,.25);
      animation: pulse 1s infinite ease-in-out;
    }
    .dot:nth-child(2){ animation-delay: .15s; }
    .dot:nth-child(3){ animation-delay: .3s; }
    @keyframes pulse{
      0%,100%{ transform: scale(1); opacity: .5; }
      50%{ transform: scale(1.35); opacity: 1; }
    }
  </style>
</head>

<body>
  <div id="app" class="wrap"></div>

  <div class="nav">
    <button id="tab0" onclick="showDashboard()" class="active">üè† –°–µ–π—á–∞—Å</button>
    <button id="tab1" onclick="showAnalytics()">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
    <button id="tab2" onclick="showAdd()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
    <button id="tab3" onclick="showRecent()">üßæ –¢—Ä–∞—Ç—ã</button>
  </div>

<script>
/* ======================================================
   TELEGRAM INIT
====================================================== */
const tg = window.Telegram?.WebApp;
if (tg) {
  tg.expand();
  const p = tg.themeParams || {};
  if (p.bg_color) document.documentElement.style.setProperty('--bg', p.bg_color);
  if (p.text_color) document.documentElement.style.setProperty('--text', p.text_color);
  if (p.hint_color) document.documentElement.style.setProperty('--muted', p.hint_color);
  if (p.button_color) document.documentElement.style.setProperty('--accent', p.button_color);
}

/* ======================================================
   üîå API WEBHOOKS (–í–°–ï –° –ü–†–ï–§–ò–ö–°–û–ú fin- –ò /webhook-test/)
   –ú–µ–Ω—è–µ—à—å —Ç—É—Ç –æ–¥–∏–Ω —Ä–∞–∑ ‚Äî –∏ –≤—Å—ë.
====================================================== */
const N8N_BASE = 'https://n8n.todobotmy.ru/webhook-test';

const API = {
  // –£ –¢–ï–ë–Ø –£–ñ–ï –ï–°–¢–¨ (GET):
  DASHBOARD: `${N8N_BASE}/fin-dashboard`,

  // –ó–∞–≥–ª—É—à–∫–∏ –ø–æ–¥ –±—É–¥—É—â–∏–µ n8n webhooks (–ø–µ—Ä–µ–∏–º–µ–Ω—É–µ—à—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏):
  ANALYTICS: `${N8N_BASE}/fin-analytics`,
  RECENT: `${N8N_BASE}/fin-expenses-recent`,
  ADD_EXPENSE: `${N8N_BASE}/fin-expenses-add`,
  UPDATE_EXPENSE: `${N8N_BASE}/fin-expenses-update`,
  DELETE_EXPENSE: `${N8N_BASE}/fin-expenses-delete`
};

const app = document.getElementById('app');

/* ======================================================
   HELPERS
====================================================== */
function setActiveTab(i){
  for (let k=0;k<4;k++){
    document.getElementById('tab'+k).classList.toggle('active', k===i);
  }
}

function fmtMoney(n, currency='‚ÇΩ'){
  if (n === null || n === undefined || n === '') return '‚Äî';
  const num = Number(n);
  if (Number.isNaN(num)) return String(n);
  return new Intl.NumberFormat('ru-RU').format(num) + ' ' + currency;
}

function nowISODate(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}

function monthKey(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  return `${yyyy}-${mm}`;
}

function loadingCard(text='–ó–∞–≥—Ä—É–∑–∫–∞'){
  return `
    <div class="card">
      <div class="loading">
        <span>${text}</span>
        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
      </div>
    </div>
  `;
}

function buildUrl(url, params){
  const u = new URL(url);
  Object.entries(params || {}).forEach(([k,v]) => {
    if (v !== undefined && v !== null && v !== '') u.searchParams.set(k, String(v));
  });
  return u.toString();
}

/**
 * GET: params –∏–¥—É—Ç –≤ query string
 * POST: JSON body (–¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ n8n)
 * initData –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö –≤—Å–µ–≥–¥–∞.
 */
async function apiFetch(url, payload={}, opts={}){
  const initData = tg?.initData || '';
  const method = (opts.method || 'POST').toUpperCase();

  const finalUrl = method === 'GET' ? buildUrl(url, {
    ...payload,
    telegram_user_id: tg?.initDataUnsafe?.user?.id
  }) : url;

  const res = await fetch(finalUrl, {
    method,
    headers: {
      ...(method === 'GET' ? {} : { 'Content-Type': 'application/json' }),
      'Authorization': initData,
      'X-Telegram-InitData': initData
    },
    body: method === 'GET' ? undefined : JSON.stringify({
      ...payload,
      initData,
      telegram_user_id: tg?.initDataUnsafe?.user?.id
    })
  });

  if (!res.ok) {
    const t = await res.text().catch(()=> '');
    throw new Error(`HTTP ${res.status}: ${t || 'Request failed'}`);
  }

  const ct = res.headers.get('content-type') || '';
  if (ct.includes('application/json')) return await res.json();
  const text = await res.text();
  try { return JSON.parse(text); } catch { return { raw: text }; }
}

/* ======================================================
   STATE
====================================================== */
let period = 'month'; // today | week | month
let activeScreen = 'dashboard';

function periodButtons(){
  return `
    <div class="seg" role="tablist" aria-label="–ü–µ—Ä–∏–æ–¥">
      <button class="${period==='today'?'active':''}" onclick="setPeriod('today')">–°–µ–≥–æ–¥–Ω—è</button>
      <button class="${period==='week'?'active':''}" onclick="setPeriod('week')">–ù–µ–¥–µ–ª—è</button>
      <button class="${period==='month'?'active':''}" onclick="setPeriod('month')">–ú–µ—Å—è—Ü</button>
    </div>
  `;
}

function setPeriod(p){
  period = p;
  if (activeScreen === 'dashboard') showDashboard();
  if (activeScreen === 'analytics') showAnalytics();
  if (activeScreen === 'recent') showRecent();
}

/* ======================================================
   SCREEN: DASHBOARD (GET)
====================================================== */
async function showDashboard(){
  activeScreen = 'dashboard';
  setActiveTab(0);

  app.innerHTML = `
    <div class="topbar">
      <div class="app-title">–†–∞—Å—Ö–æ–¥—ã</div>
      ${periodButtons()}
    </div>
    ${loadingCard('Dashboard')}
  `;

  try {
    // GET params ‚Äî –ø–æ–¥—Å—Ç—Ä–æ–∏—à—å –ø–æ–¥ —Ç–æ, —á—Ç–æ –∂–¥—ë—Ç —Ç–≤–æ–π fin-dashboard
    const params = {
      period,               // today/week/month
      date: nowISODate(),   // —É–¥–æ–±–Ω–æ –¥–ª—è today/week
      month: monthKey()     // —É–¥–æ–±–Ω–æ –¥–ª—è month
    };

    const data = await apiFetch(API.DASHBOARD, params, { method: 'GET' });

    const currency = data.currency || '‚ÇΩ';
    const budgets = Array.isArray(data.budgets) ? data.budgets : [];
    const insight = data.insight || null;

    app.innerHTML = `
      <div class="topbar">
        <div class="app-title">–†–∞—Å—Ö–æ–¥—ã</div>
        ${periodButtons()}
      </div>

      <div class="card">
        <div class="label">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ (${period==='today'?'—Å–µ–≥–æ–¥–Ω—è':period==='week'?'–∑–∞ –Ω–µ–¥–µ–ª—é':'–∑–∞ –º–µ—Å—è—Ü'})</div>
        <div class="big">${fmtMoney(data.spent, currency)}</div>
        ${data.forecast !== undefined ? `<div class="sub">–ü—Ä–æ–≥–Ω–æ–∑: ${fmtMoney(data.forecast, currency)}</div>` : ''}
      </div>

      ${
        budgets.length ? `
        <div class="card">
          <div class="row">
            <div>
              <div class="title">–ë—é–¥–∂–µ—Ç—ã</div>
              <div class="sub">–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ç—É—Å –ø–æ –ª–∏–º–∏—Ç–∞–º</div>
            </div>
            <span class="pill">–ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</span>
          </div>
          <div class="list">
            ${budgets.slice(0,5).map(b=>{
              const pct = b.percent ?? (b.limit ? Math.round((b.spent/b.limit)*100) : null);
              let cls = 'ok';
              if (pct >= 100) cls = 'bad';
              else if (pct >= 80) cls = 'warn';
              return `
                <div class="item">
                  <div class="left">
                    <div class="name">${b.category_name || b.category || '–ö–∞—Ç–µ–≥–æ—Ä–∏—è'}</div>
                    <div class="meta">${fmtMoney(b.spent, currency)} –∏–∑ ${fmtMoney(b.limit, currency)}</div>
                  </div>
                  <div class="right">
                    <span class="pill ${cls}">${pct !== null ? (pct + '%') : '‚Äî'}</span>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
        ` : ''
      }

      ${
        insight?.text ? `
        <div class="card">
          <div class="row">
            <div>
              <div class="title">–ò–Ω—Å–∞–π—Ç</div>
              <div class="sub">${insight.text}</div>
            </div>
            <span class="pill">${insight.severity || 'info'}</span>
          </div>
        </div>
        ` : ''
      }

      <div class="hint">
        Dashboard –∏–¥—ë—Ç GET –Ω–∞ <b>${API.DASHBOARD}</b>.<br>
        –ï—Å–ª–∏ –≤–∏–¥–∏—à—å CORS-–æ—à–∏–±–∫—É ‚Äî –Ω–∞–¥–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ–º–µ–Ω GitHub Pages –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö/–ø—Ä–æ–∫—Å–∏.
      </div>
    `;
  } catch (e){
    app.innerHTML = `
      <div class="topbar">
        <div class="app-title">–†–∞—Å—Ö–æ–¥—ã</div>
        ${periodButtons()}
      </div>
      <div class="card">
        <div class="title">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
        <div class="sub">${String(e.message || e)}</div>
        <div class="divider"></div>
        <button class="btn" onclick="showDashboard()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
      </div>
    `;
    tg?.HapticFeedback?.notificationOccurred('error');
  }
}

/* ======================================================
   SCREEN: ANALYTICS (–ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞ –ø–æ–¥ —Ç–≤–æ–π –±—É–¥—É—â–∏–π fin-analytics)
====================================================== */
async function showAnalytics(){
  activeScreen = 'analytics';
  setActiveTab(1);

  app.innerHTML = `
    <div class="topbar">
      <div class="app-title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
      ${periodButtons()}
    </div>
    ${loadingCard('Analytics')}
  `;

  try{
    const data = await apiFetch(API.ANALYTICS, { period, date: nowISODate(), month: monthKey() }, { method: 'POST' });
    const currency = data.currency || '‚ÇΩ';
    const cats = Array.isArray(data.categories) ? data.categories : [];
    const total = cats.reduce((s,c)=> s + (Number(c.amount)||0), 0) || (Number(data.total)||0);

    app.innerHTML = `
      <div class="topbar">
        <div class="app-title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
        ${periodButtons()}
      </div>

      <div class="card">
        <div class="label">–í—Å–µ–≥–æ</div>
        <div class="big">${fmtMoney(total, currency)}</div>
        <div class="sub">–¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (${period})</div>

        <div class="list">
          ${
            cats.length ? cats.slice(0,10).map(c=>{
              const amt = Number(c.amount)||0;
              const pct = total ? Math.round((amt/total)*100) : 0;
              return `
                <div class="item">
                  <div class="left">
                    <div class="name">${c.name || c.category_name || '–ö–∞—Ç–µ–≥–æ—Ä–∏—è'}</div>
                    <div class="meta">${pct}% –æ—Ç –≤—Å–µ—Ö —Ç—Ä–∞—Ç</div>
                  </div>
                  <div class="right">
                    <div class="amt">${fmtMoney(amt, currency)}</div>
                  </div>
                </div>
              `;
            }).join('') : `<div class="sub">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</div>`
          }
        </div>
      </div>
    `;
  } catch(e){
    app.innerHTML = `
      <div class="card">
        <div class="title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</div>
        <div class="sub">${String(e.message || e)}</div>
        <div class="hint">–°–¥–µ–ª–∞–π webhook <b>fin-analytics</b> –∏–ª–∏ –ø–æ–º–µ–Ω—è–π URL –≤ API.</div>
        <button class="btn" onclick="showAnalytics()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
      </div>
    `;
  }
}

/* ======================================================
   SCREEN: ADD EXPENSE (–ø–æ–¥ fin-expenses-add)
====================================================== */
function showAdd(){
  activeScreen = 'add';
  setActiveTab(2);

  const today = nowISODate();

  app.innerHTML = `
    <div class="topbar">
      <div class="app-title">–î–æ–±–∞–≤–∏—Ç—å</div>
      <span class="pill">–±—ã—Å—Ç—Ä–æ</span>
    </div>

    <div class="card">
      <div class="label">–°—É–º–º–∞</div>
      <input class="input" id="amount" type="number" inputmode="decimal" placeholder="350" />

      <div class="label" style="margin-top:10px;">–û–ø–∏—Å–∞–Ω–∏–µ</div>
      <input class="input" id="description" placeholder="–∫–æ—Ñ–µ, —Ç–∞–∫—Å–∏, –ø—Ä–æ–¥—É–∫—Ç—ã..." />

      <div class="grid2" style="margin-top:10px;">
        <div>
          <div class="label">–î–∞—Ç–∞</div>
          <input class="input" id="date" type="date" value="${today}" />
        </div>
        <div>
          <div class="label">–ü–µ—Ä–∏–æ–¥</div>
          <div class="pill">${period}</div>
        </div>
      </div>

      <button class="btn" onclick="submitExpense()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <div class="hint">–ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—é –∏ –ª–æ–≥–∏–∫—É –¥–µ–ª–∞–µ—Ç n8n.</div>
    </div>
  `;
}

async function submitExpense(){
  const amount = document.getElementById('amount').value;
  const description = document.getElementById('description').value || '';
  const date = document.getElementById('date').value || nowISODate();

  if (!amount || Number(amount) <= 0){
    tg?.showAlert('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É');
    return;
  }

  try{
    await apiFetch(API.ADD_EXPENSE, { amount: Number(amount), description, date }, { method: 'POST' });

    tg?.HapticFeedback?.notificationOccurred('success');
    tg?.showPopup({
      title: '–ì–æ—Ç–æ–≤–æ',
      message: '–¢—Ä–∞—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞',
      buttons: [{ type: 'ok' }]
    });

    showDashboard();
  } catch(e){
    tg?.HapticFeedback?.notificationOccurred('error');
    tg?.showAlert(`–û—à–∏–±–∫–∞: ${String(e.message || e)}`);
  }
}

/* ======================================================
   SCREEN: RECENT (–ø–æ–¥ fin-expenses-recent)
====================================================== */
async function showRecent(){
  activeScreen = 'recent';
  setActiveTab(3);

  app.innerHTML = `
    <div class="topbar">
      <div class="app-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞—Ç—ã</div>
      ${periodButtons()}
    </div>
    ${loadingCard('Recent')}
  `;

  try{
    const data = await apiFetch(API.RECENT, { period, date: nowISODate(), month: monthKey(), limit: 25 }, { method: 'POST' });
    const currency = data.currency || '‚ÇΩ';
    const items = Array.isArray(data.expenses) ? data.expenses : (Array.isArray(data) ? data : []);

    app.innerHTML = `
      <div class="topbar">
        <div class="app-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞—Ç—ã</div>
        ${periodButtons()}
      </div>

      <div class="card">
        <div class="row">
          <div>
            <div class="title">–°–ø–∏—Å–æ–∫</div>
            <div class="sub">–ë—ã—Å—Ç—Ä–æ —É–¥–∞–ª–∏—Ç—å / –ø—Ä–æ–≤–µ—Ä–∏—Ç—å</div>
          </div>
          <span class="pill">${items.length} —à—Ç</span>
        </div>

        <div class="list">
          ${
            items.length ? items.map(x=>{
              const id = x.id || x.expense_id || '';
              const name = x.description || x.comment || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è';
              const cat = x.category || x.category_name || '';
              const dt = x.date || x.created_at || '';
              return `
                <div class="item">
                  <div class="left">
                    <div class="name">${name}</div>
                    <div class="meta">${[cat, dt].filter(Boolean).join(' ‚Ä¢ ')}</div>
                  </div>
                  <div class="right">
                    <div class="amt">${fmtMoney(x.amount, currency)}</div>
                    ${id ? `<button class="mini-btn danger" onclick="deleteExpense('${id}')">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
                  </div>
                </div>
              `;
            }).join('') : `<div class="sub">–ü–æ–∫–∞ –ø—É—Å—Ç–æ.</div>`
          }
        </div>
      </div>

      <div class="hint">–ï—Å–ª–∏ RECENT –µ—â—ë –Ω–µ —Å–¥–µ–ª–∞–Ω ‚Äî —Å–æ–∑–¥–∞–π webhook <b>fin-expenses-recent</b> –∏–ª–∏ –ø–æ–º–µ–Ω—è–π URL –≤ API.</div>
    `;
  } catch(e){
    app.innerHTML = `
      <div class="card">
        <div class="title">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å</div>
        <div class="sub">${String(e.message || e)}</div>
        <button class="btn" onclick="showRecent()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
      </div>
    `;
  }
}

async function deleteExpense(id){
  if (!id) return;

  if (tg){
    tg.showPopup({
      title: '–£–¥–∞–ª–∏—Ç—å?',
      message: '–¢—Ä–∞—Ç–∞ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞',
      buttons: [
        { id: 'cancel', type: 'cancel', text: '–û—Ç–º–µ–Ω–∞' },
        { id: 'ok', type: 'destructive', text: '–£–¥–∞–ª–∏—Ç—å' }
      ]
    }, async (btnId) => {
      if (btnId !== 'ok') return;
      try{
        await apiFetch(API.DELETE_EXPENSE, { id }, { method: 'POST' });
        tg.HapticFeedback?.notificationOccurred('success');
        showRecent();
      } catch(e){
        tg.HapticFeedback?.notificationOccurred('error');
        tg.showAlert(`–û—à–∏–±–∫–∞: ${String(e.message || e)}`);
      }
    });
  } else {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç—Ä–∞—Ç—É?')) return;
    await apiFetch(API.DELETE_EXPENSE, { id }, { method: 'POST' });
    showRecent();
  }
}

/* ======================================================
   INIT
====================================================== */
showDashboard();
</script>
</body>
</html>
