<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Expenses Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg: #0b0b0f;
      --card: #1c1c1e;
      --muted: rgba(255,255,255,.65);
      --text: #ffffff;
      --border: rgba(255,255,255,.08);
      --accent: #2ea6ff;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --radius: 16px;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .wrap { padding: 14px 14px 88px; }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin: 6px 0 12px;
    }
    .app-title{
      font-weight: 700;
      font-size: 18px;
      letter-spacing: .2px;
    }

    .seg{
      display:flex;
      gap:6px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--border);
      padding: 6px;
      border-radius: 999px;
    }
    .seg button{
      border:0;
      background: transparent;
      color: var(--muted);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 13px;
      cursor:pointer;
    }
    .seg button.active{
      background: rgba(255,255,255,.10);
      color: var(--text);
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
      margin-bottom: 10px;
    }

    .row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }
    .label{
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 6px;
    }
    .big{
      font-size: 28px;
      font-weight: 800;
      letter-spacing: .2px;
      line-height: 1.1;
    }
    .sub{
      color: var(--muted);
      font-size: 13px;
      margin-top: 6px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border:1px solid var(--border);
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
    }
    .pill.warn{ color: #ffd479; }
    .pill.ok{ color: #8cffb1; }
    .pill.bad{ color: #ff8c8c; }

    .list{ margin-top: 6px; }
    .item{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding: 10px 0;
      border-top: 1px solid var(--border);
    }
    .item:first-child{ border-top: 0; }
    .item .left{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 0;
    }
    .item .name{
      font-size: 14px;
      font-weight: 600;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 230px;
    }
    .item .meta{
      color: var(--muted);
      font-size: 12px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .item .right{
      text-align:right;
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-end;
    }
    .amt{
      font-weight: 800;
      font-size: 14px;
    }
    .mini-btn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 12px;
      cursor:pointer;
    }
    .mini-btn.danger{ color: #ff9a9a; }

    .btn{
      width: 100%;
      border:0;
      background: var(--accent);
      color: #001018;
      font-weight: 800;
      padding: 14px 14px;
      border-radius: 14px;
      cursor:pointer;
      font-size: 16px;
      margin-top: 10px;
    }

    .input{
      width: 100%;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 16px;
      outline: none;
    }
    .input::placeholder{ color: rgba(255,255,255,.35); }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .nav{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      background: rgba(18,18,22,.92);
      backdrop-filter: blur(14px);
      border-top: 1px solid var(--border);
      display:flex;
      gap: 8px;
    }
    .nav button{
      flex: 1;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      padding: 10px 8px;
      border-radius: 14px;
      font-size: 13px;
      cursor:pointer;
    }
    .nav button.active{
      color: var(--text);
      border-color: rgba(46,166,255,.35);
      background: rgba(46,166,255,.14);
    }

    .hint{
      color: rgba(255,255,255,.45);
      font-size: 12px;
      margin-top: 8px;
      line-height: 1.35;
    }

    .divider{
      height: 1px;
      background: var(--border);
      margin: 10px 0;
    }

    .loading{
      display:flex; gap:10px; align-items:center; color: var(--muted);
    }
    .dot{
      width: 8px; height: 8px; border-radius: 50%;
      background: rgba(255,255,255,.25);
      animation: pulse 1s infinite ease-in-out;
    }
    .dot:nth-child(2){ animation-delay: .15s; }
    .dot:nth-child(3){ animation-delay: .3s; }
    @keyframes pulse{
      0%,100%{ transform: scale(1); opacity: .5; }
      50%{ transform: scale(1.35); opacity: 1; }
    }
  
    /* Analytics visuals */
    .kpis{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .kpi{
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      border-radius: 16px;
      padding: 12px;
    }
    .kpi .kpi-label{ font-size: 12px; color: var(--muted); }
    .kpi .kpi-value{ font-size: 20px; font-weight: 800; margin-top: 6px; }
    .kpi .kpi-sub{ font-size: 12px; color: var(--muted); margin-top: 6px; }

    .donut-wrap{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap: 12px;
      align-items:center;
      margin-top: 10px;
    }
    .donut{
      width: 140px;
      height: 140px;
      border-radius: 50%;
      background: conic-gradient(rgba(255,255,255,.12) 0 360deg);
      position: relative;
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
    }
    .donut::after{
      content:'';
      position:absolute;
      inset: 16px;
      border-radius: 50%;
      background: rgba(15,20,27,.92);
      border: 1px solid rgba(255,255,255,.08);
    }
    .donut-center{
      position:absolute;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      z-index: 1;
      pointer-events:none;
      text-align:center;
      padding: 0 14px;
    }
    .donut-center .dc-big{ font-weight: 900; font-size: 16px; }
    .donut-center .dc-sub{ font-size: 12px; color: var(--muted); margin-top: 4px; }

    .legend{
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    .legend-row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding: 8px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.14);
    }
    .legend-left{
      display:flex;
      align-items:flex-start;
      gap:10px;
      min-width: 0;
    }
    .dotc{
      width: 10px; height: 10px;
      border-radius: 999px;
      margin-top: 4px;
      flex: 0 0 auto;
      background: rgba(255,255,255,.30);
      border: 1px solid rgba(255,255,255,.18);
    }
    .legend-name{
      font-size: 13px;
      font-weight: 700;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 180px;
    }
    .legend-sub{
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }
    .spark{
      margin-top: 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.14);
      padding: 10px;
    }
    .spark svg{ width: 100%; height: 70px; display:block; }
    .spark .spark-meta{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-top: 8px;
      color: var(--muted);
      font-size: 12px;
    }
    .muted{ color: var(--muted); }

  
    /* ===== Analytics extras ===== */
    .kpi-row{ display:flex; gap:10px; margin-top:10px; }
    .kpi{ flex:1; background: rgba(255,255,255,.04); border:1px solid var(--border); border-radius: 14px; padding: 10px; }
    .kpi .k{ color: var(--muted); font-size: 12px; margin-bottom: 4px; }
    .kpi .v{ font-weight: 800; font-size: 15px; }

    .donut-wrap{ display:flex; gap:14px; align-items:center; margin-top: 10px; }
    .donut{
      width: 140px; height: 140px;
      border-radius: 50%;
      background: conic-gradient(from -90deg, rgba(255,255,255,.12) 0 360deg);
      position: relative;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      flex: 0 0 auto;
    }
    .donut::after{
      content:'';
      position:absolute;
      inset: 22%;
      border-radius: 50%;
      background: var(--card);
      border: 1px solid var(--border);
    }
    .donut-center{
      position:absolute;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      z-index: 2;
      text-align:center;
      padding: 10px;
      pointer-events:none;
    }
    .donut-center .t{ font-weight: 900; font-size: 14px; }
    .donut-center .s{ color: var(--muted); font-size: 11px; margin-top: 4px; }

    .legend{ flex: 1; min-width: 0; }
    .legend .lg-item{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; padding: 8px 0; border-top:1px solid var(--border); }
    .legend .lg-item:first-child{ border-top:0; padding-top:0; }
    .lg-left{ display:flex; flex-direction:column; gap:3px; min-width: 0; }
    .lg-name{ display:flex; align-items:center; gap:8px; font-weight: 650; font-size: 14px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .sw{ width:10px; height:10px; border-radius: 3px; flex:0 0 auto; margin-top: 3px; }
    .lg-meta{ color: var(--muted); font-size: 12px; }
    .lg-right{ text-align:right; display:flex; flex-direction:column; gap:4px; align-items:flex-end; }
    .lg-amt{ font-weight: 900; font-size: 13px; white-space:nowrap; }

    .spark{ margin-top: 12px; }
    .spark svg{ width: 100%; height: 64px; display:block; }
    .spark .cap{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 6px; }
    .spark .cap .label{ margin:0; }

    /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è */
    .add-btn-container {
      position: fixed;
      right: 20px;
      bottom: 90px;
      z-index: 100;
    }
    
    .add-btn {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--accent);
      border: none;
      color: #001018;
      font-size: 28px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(46, 166, 255, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .add-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(46, 166, 255, 0.4);
    }
    
    .add-btn:active {
      transform: scale(0.95);
    }
    
    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      opacity: 0;
      animation: fadeIn 0.2s forwards;
    }
    
    @keyframes fadeIn {
      to { opacity: 1; }
    }
    
    .modal {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      width: 100%;
      max-width: 400px;
      box-shadow: var(--shadow);
      transform: translateY(20px);
      animation: slideUp 0.3s forwards;
    }
    
    @keyframes slideUp {
      to { transform: translateY(0); }
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 700;
    }
    
    .close-btn {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 24px;
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
    }
    
    .close-btn:hover {
      background: rgba(255,255,255,.06);
    }
    
    /* –ù–æ–≤—ã–µ —Ü–≤–µ—Ç–∞ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ä–∞—Å—Ö–æ–¥–æ–≤ */
    .expense-low { color: #8cffb1; } /* –ó–µ–ª–µ–Ω—ã–π */
    .expense-medium { color: #ffd479; } /* –ñ–µ–ª—Ç—ã–π */
    .expense-high { color: #ff8c8c; } /* –ö—Ä–∞—Å–Ω—ã–π */
    .expense-neutral { color: var(--accent); } /* –ê–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç */

  </style>
</head>

<body>
  <div id="app" class="wrap"></div>
  
  <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
  <div class="add-btn-container">
    <button class="add-btn" onclick="showAddModal()">+</button>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
  <div id="addModal" class="modal-overlay" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞—Ç—É</div>
        <button class="close-btn" onclick="closeAddModal()">√ó</button>
      </div>
      <div class="label">–°—É–º–º–∞</div>
      <input class="input" id="modalAmount" type="number" inputmode="decimal" placeholder="350" />
      
      <div class="label" style="margin-top:10px;">–û–ø–∏—Å–∞–Ω–∏–µ</div>
      <input class="input" id="modalDescription" placeholder="–∫–æ—Ñ–µ, —Ç–∞–∫—Å–∏, –ø—Ä–æ–¥—É–∫—Ç—ã..." />
      
      <div class="label" style="margin-top:10px;">–î–∞—Ç–∞</div>
      <input class="input" id="modalDate" type="date" />
      
      <button class="btn" onclick="submitExpenseModal()" style="margin-top: 20px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>

  <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è —Å 3 –∫–Ω–æ–ø–∫–∞–º–∏ -->
  <div class="nav">
    <button id="tab0" onclick="showDashboard()" class="active">üè† –°–µ–π—á–∞—Å</button>
    <button id="tab1" onclick="showAnalytics()">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
    <button id="tab2" onclick="showRecent()">üßæ –¢—Ä–∞—Ç—ã</button>
  </div>

<script>
/* ======================================================
   TELEGRAM INIT
====================================================== */
let tg;
try {
  tg = window.Telegram?.WebApp;
  if (tg) {
    tg.expand();
    const p = tg.themeParams || {};
    if (p.bg_color) document.documentElement.style.setProperty('--bg', p.bg_color);
    if (p.text_color) document.documentElement.style.setProperty('--text', p.text_color);
    if (p.hint_color) document.documentElement.style.setProperty('--muted', p.hint_color);
    if (p.button_color) document.documentElement.style.setProperty('--accent', p.button_color);
  }
} catch (e) {
  console.warn('Telegram WebApp not available:', e);
  tg = null;
}

/* ======================================================
   üîå API WEBHOOKS
====================================================== */
const N8N_BASE = 'https://n8n.todobotmy.ru/webhook';

const API = {
  DASHBOARD: `${N8N_BASE}/fin-dashboard`,
  ANALYTICS: `${N8N_BASE}/fin-analytics`,
  RECENT: `${N8N_BASE}/fin-expenses-recent`,
  ADD_EXPENSE: `${N8N_BASE}/fin-expenses-add`,
  UPDATE_EXPENSE: `${N8N_BASE}/fin-expenses-update`,
  DELETE_EXPENSE: `${N8N_BASE}/fin-expenses-delete`
};

const app = document.getElementById('app');

/* ======================================================
   –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û
====================================================== */
function showAddModal() {
  const modal = document.getElementById('addModal');
  const today = nowISODate();
  document.getElementById('modalDate').value = today;
  document.getElementById('modalAmount').value = '';
  document.getElementById('modalDescription').value = '';
  modal.style.display = 'flex';
}

function closeAddModal() {
  document.getElementById('addModal').style.display = 'none';
}

/* ======================================================
   HELPERS
====================================================== */
function setActiveTab(i){
  for (let k=0;k<3;k++){
    const btn = document.getElementById('tab'+k);
    if (btn) btn.classList.toggle('active', k===i);
  }
}

function fmtMoney(n, currency='‚ÇΩ'){
  if (n === null || n === undefined || n === '') return '‚Äî';
  const num = Number(n);
  if (Number.isNaN(num)) return String(n);
  return new Intl.NumberFormat('ru-RU').format(num) + ' ' + currency;
}

function nowISODate(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}

function monthKey(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  return `${yyyy}-${mm}`;
}

function loadingCard(text='–ó–∞–≥—Ä—É–∑–∫–∞'){
  return `
    <div class="card">
      <div class="loading">
        <span>${text}</span>
        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
      </div>
    </div>
  `;
}

function buildUrl(url, params){
  const u = new URL(url);
  Object.entries(params || {}).forEach(([k,v]) => {
    if (v !== undefined && v !== null && v !== '') u.searchParams.set(k, String(v));
  });
  return u.toString();
}

function escapeHtml(str){
  const s = String(str ?? '');
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

function unwrapN8n(x){
  if (Array.isArray(x)) return x[0] ?? {};
  return x ?? {};
}

function labelForPeriod(p){
  if (p==='today') return '–°–µ–≥–æ–¥–Ω—è';
  if (p==='week') return '–ù–µ–¥–µ–ª—è';
  return '–ú–µ—Å—è—Ü';
}

function colorForIndex(i){
  // –ù–æ–≤—ã–µ —Ü–≤–µ—Ç–∞ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —Ç–µ–º–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  const colors = [
    '#2ea6ff',  // –æ—Å–Ω–æ–≤–Ω–æ–π –∞–∫—Ü–µ–Ω—Ç–Ω—ã–π
    '#8cffb1',  // –∑–µ–ª–µ–Ω—ã–π
    '#ffd479',  // –∂–µ–ª—Ç—ã–π/–æ—Ä–∞–Ω–∂–µ–≤—ã–π
    '#ff8c8c',  // –∫—Ä–∞—Å–Ω—ã–π
    '#b388ff',  // —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π
    '#7afcff',  // –≥–æ–ª—É–±–æ–π
    '#ff9a9a',  // —Ä–æ–∑–æ–≤—ã–π
    '#ffb347',  // –ø–µ—Ä—Å–∏–∫–æ–≤—ã–π
    '#c5e1a5',  // —Å–≤–µ—Ç–ª—ã–π –∑–µ–ª–µ–Ω—ã–π
    '#80deea'   // –±–∏—Ä—é–∑–æ–≤—ã–π
  ];
  return colors[i % colors.length];
}

function buildDonutGradient(parts){
  const total = parts.reduce((s,p)=>s + (Number(p.amount)||0), 0) || 0;
  if (!total) return `conic-gradient(from -90deg, rgba(255,255,255,.12) 0 360deg)`;
  let acc = 0;
  const stops = parts.map(p=>{
    const a = Number(p.amount)||0;
    const start = acc;
    const deg = (a / total) * 360;
    acc += deg;
    return `${p.color} ${start.toFixed(2)}deg ${acc.toFixed(2)}deg`;
  });
  return `conic-gradient(from -90deg, ${stops.join(',')})`;
}

function sparklineSvg(points){
  const w = 320, h = 64, pad = 6;
  const vals = (points || []).map(x => Number(x)||0);
  const max = Math.max(1, ...vals);
  const n = vals.length || 1;
  const step = (w - pad*2) / Math.max(1, n-1);

  const pts = vals.map((v, i) => {
    const x = pad + step * i;
    const y = (h - pad) - (v / max) * (h - pad*2);
    return `${x.toFixed(2)},${y.toFixed(2)}`;
  }).join(' ');

  const area = `${pad},${h-pad} ${pts} ${w-pad},${h-pad}`;

  return `
    <svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none" aria-label="–ì—Ä–∞—Ñ–∏–∫ —Ç—Ä–∞—Ç">
      <polyline points="${area}" fill="rgba(46,166,255,.10)" stroke="none"></polyline>
      <polyline points="${pts}" fill="none" stroke="var(--accent)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></polyline>
    </svg>
  `;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–ª–∞—Å—Å–∞ —Ü–≤–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—É–º–º—ã
function getExpenseColorClass(amount) {
  const numAmount = Number(amount) || 0;
  if (numAmount < 1000) return 'expense-low';
  if (numAmount < 5000) return 'expense-medium';
  return 'expense-high';
}

async function apiFetch(url, payload={}, opts={}){
  const method = (opts.method || 'POST').toUpperCase();
  const initData = tg?.initData || '';
  const userId = tg?.initDataUnsafe?.user?.id || '';

  const finalUrl = method === 'GET' ? buildUrl(url, {
    ...payload,
    telegram_user_id: userId
  }) : url;

  const headers = {
    'Authorization': initData,
    'X-Telegram-InitData': initData
  };

  if (method !== 'GET') {
    headers['Content-Type'] = 'application/json';
  }

  const options = {
    method,
    headers,
    body: method === 'GET' ? undefined : JSON.stringify({
      ...payload,
      initData,
      telegram_user_id: userId
    })
  };

  try {
    const res = await fetch(finalUrl, options);
    
    if (!res.ok) {
      const text = await res.text();
      throw new Error(`HTTP ${res.status}: ${text || 'Request failed'}`);
    }

    const contentType = res.headers.get('content-type');
    if (contentType && contentType.includes('application/json')) {
      return await res.json();
    }
    
    const text = await res.text();
    try {
      return JSON.parse(text);
    } catch {
      return { raw: text };
    }
  } catch (error) {
    console.error('API fetch error:', error);
    throw error;
  }
}

/* ======================================================
   STATE
====================================================== */
let period = 'month';
let activeScreen = 'dashboard';

function periodButtons(){
  return `
    <div class="seg" role="tablist" aria-label="–ü–µ—Ä–∏–æ–¥">
      <button class="${period==='today'?'active':''}" onclick="setPeriod('today')">–°–µ–≥–æ–¥–Ω—è</button>
      <button class="${period==='week'?'active':''}" onclick="setPeriod('week')">–ù–µ–¥–µ–ª—è</button>
      <button class="${period==='month'?'active':''}" onclick="setPeriod('month')">–ú–µ—Å—è—Ü</button>
    </div>
  `;
}

function setPeriod(p){
  period = p;
  if (activeScreen === 'dashboard') showDashboard();
  else if (activeScreen === 'analytics') showAnalytics();
  else if (activeScreen === 'recent') showRecent();
}

/* ======================================================
   SCREEN: DASHBOARD (GET)
====================================================== */
async function showDashboard(){
  try {
    activeScreen = 'dashboard';
    setActiveTab(0);

    app.innerHTML = `
      <div class="topbar">
        <div class="app-title">–†–∞—Å—Ö–æ–¥—ã</div>
        ${periodButtons()}
      </div>
      ${loadingCard('–ó–∞–≥—Ä—É–∑–∫–∞...')}
    `;

    const params = {
      period,
      date: nowISODate(),
      month: monthKey()
    };

    const data = unwrapN8n(await apiFetch(API.DASHBOARD, params, { method: 'GET' }));
    const currency = data.currency || '‚ÇΩ';
    const budgets = Array.isArray(data.budgets) ? data.budgets : [];
    const insight = data.insight || null;

    app.innerHTML = `
      <div class="topbar">
        <div class="app-title">–†–∞—Å—Ö–æ–¥—ã</div>
        ${periodButtons()}
      </div>

      <div class="card">
        <div class="label">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ (${period==='today'?'—Å–µ–≥–æ–¥–Ω—è':period==='week'?'–∑–∞ –Ω–µ–¥–µ–ª—é':'–∑–∞ –º–µ—Å—è—Ü'})</div>
        <div class="big">${fmtMoney(data.spent, currency)}</div>
        ${data.forecast !== undefined ? `<div class="sub">–ü—Ä–æ–≥–Ω–æ–∑: ${fmtMoney(data.forecast, currency)}</div>` : ''}
      </div>

      ${
        budgets.length ? `
        <div class="card">
          <div class="row">
            <div>
              <div style="font-size: 16px; font-weight: 700;">–ë—é–¥–∂–µ—Ç—ã</div>
              <div class="sub">–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ç—É—Å –ø–æ –ª–∏–º–∏—Ç–∞–º</div>
            </div>
            <span class="pill">–ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</span>
          </div>
          <div class="list">
            ${budgets.slice(0,5).map(b=>{
              const pct = b.percent ?? (b.limit ? Math.round((b.spent/b.limit)*100) : null);
              let cls = 'ok';
              if (pct >= 100) cls = 'bad';
              else if (pct >= 80) cls = 'warn';
              return `
                <div class="item">
                  <div class="left">
                    <div class="name">${escapeHtml(b.category_name || b.category || '–ö–∞—Ç–µ–≥–æ—Ä–∏—è')}</div>
                    <div class="meta">${fmtMoney(b.spent, currency)} –∏–∑ ${fmtMoney(b.limit, currency)}</div>
                  </div>
                  <div class="right">
                    <span class="pill ${cls}">${pct !== null ? (pct + '%') : '‚Äî'}</span>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
        ` : ''
      }

      ${
        insight?.text ? `
        <div class="card">
          <div class="row">
            <div>
              <div style="font-size: 16px; font-weight: 700;">–ò–Ω—Å–∞–π—Ç</div>
              <div class="sub">${escapeHtml(insight.text)}</div>
            </div>
            <span class="pill">${escapeHtml(insight.severity || 'info')}</span>
          </div>
        </div>
        ` : ''
      }
    `;
  } catch (e){
    app.innerHTML = `
      <div class="topbar">
        <div class="app-title">–†–∞—Å—Ö–æ–¥—ã</div>
        ${periodButtons()}
      </div>
      <div class="card">
        <div style="font-size: 16px; font-weight: 700;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
        <div class="sub">${escapeHtml(String(e.message || e))}</div>
        <div class="divider"></div>
        <button class="btn" onclick="showDashboard()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
      </div>
    `;
    tg?.HapticFeedback?.notificationOccurred('error');
  }
}

/* ======================================================
   SCREEN: ANALYTICS (GET)
====================================================== */
async function showAnalytics(){
  try {
    activeScreen = 'analytics';
    setActiveTab(1);

    app.innerHTML = `
      <div class="topbar">
        <div class="app-title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
        ${periodButtons()}
      </div>
      ${loadingCard('–ó–∞–≥—Ä—É–∑–∫–∞...')}
    `;

    const raw = await apiFetch(API.ANALYTICS, { 
      period, 
      date: nowISODate(), 
      month: monthKey() 
    }, { 
      method: 'GET' 
    });
    
    const data = unwrapN8n(raw);
    const currency = data.currency || '‚ÇΩ';
    const catsRaw = Array.isArray(data.categories) ? data.categories : [];
    const timeline = Array.isArray(data.timeline) ? data.timeline : [];
    const topExpenses = Array.isArray(data.top_expenses) ? data.top_expenses : [];

    const total = Number(data.total) || catsRaw.reduce((s,c)=> s + (Number(c.amount)||0), 0) || 0;
    const prevTotal = (data.prev_total !== undefined && data.prev_total !== null) ? Number(data.prev_total) : null;

    const catsSorted = catsRaw
      .map(c => ({ 
        name: String(c.name || c.category_name || '').trim() || '–ö–∞—Ç–µ–≥–æ—Ä–∏—è', 
        amount: Number(c.amount)||0 
      }))
      .filter(c => c.amount > 0)
      .sort((a,b)=> b.amount - a.amount);

    const topN = 5;
    const catsTop = catsSorted.slice(0, topN);
    const restSum = catsSorted.slice(topN).reduce((s,c)=> s + c.amount, 0);
    if (restSum > 0) catsTop.push({ name: '–ø—Ä–æ—á–µ–µ', amount: restSum });

    const donutParts = catsTop.map((c, i) => ({ 
      ...c, 
      color: colorForIndex(i) 
    }));
    const donutBg = buildDonutGradient(donutParts);

    let delta = null, deltaPct = null;
    if (prevTotal !== null && !Number.isNaN(prevTotal)){
      delta = total - prevTotal;
      if (prevTotal > 0) {
        deltaPct = Math.round((delta / prevTotal) * 100);
      } else {
        deltaPct = total > 0 ? 100 : 0;
      }
    }

    const points = timeline.map(t => Number(t.amount)||0);
    const spark = (timeline.length >= 2) ? sparklineSvg(points) : '';

    app.innerHTML = `
      <div class="topbar">
        <div class="app-title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
        ${periodButtons()}
      </div>

      <div class="card">
        <div class="label">–ò—Ç–æ–≥–æ ‚Ä¢ ${labelForPeriod(period).toLowerCase()}</div>
        <div class="big">${fmtMoney(total, currency)}</div>

        ${
          (prevTotal !== null && !Number.isNaN(prevTotal)) ? `
          <div class="kpi-row">
            <div class="kpi">
              <div class="k">–ü—Ä–æ—à–ª—ã–π –ø–µ—Ä–∏–æ–¥</div>
              <div class="v">${fmtMoney(prevTotal, currency)}</div>
            </div>
            <div class="kpi">
              <div class="k">–ò–∑–º–µ–Ω–µ–Ω–∏–µ</div>
              <div class="v">
                ${delta >= 0 ? '+' : ''}${fmtMoney(delta, currency)}
                ${deltaPct !== null ? `<span class="pill ${delta > 0 ? 'warn' : (delta < 0 ? 'ok' : '')}" style="margin-left:8px;">${deltaPct >= 0 ? '+' : ''}${deltaPct}%</span>` : ''}
              </div>
            </div>
          </div>` : ''
        }

        ${
          total > 0 && donutParts.length ? `
          <div class="donut-wrap">
            <div class="donut" style="background:${donutBg}">
              <div class="donut-center">
                <div class="t">${fmtMoney(total, currency)}</div>
                <div class="s">—Å—Ç—Ä—É–∫—Ç—É—Ä–∞</div>
              </div>
            </div>

            <div class="legend">
              ${donutParts.map((c,i)=>{
                const pct = total ? Math.round((c.amount / total) * 100) : 0;
                return `
                  <div class="lg-item">
                    <div class="lg-left">
                      <div class="lg-name">
                        <span class="sw" style="background:${c.color}"></span>
                        <span>${escapeHtml(c.name)}</span>
                      </div>
                      <div class="lg-meta">${pct}%</div>
                    </div>
                    <div class="lg-right">
                      <div class="lg-amt">${fmtMoney(c.amount, currency)}</div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>` : `<div class="sub" style="margin-top:10px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø–µ—Ä–∏–æ–¥.</div>`
        }

        ${
          spark ? `
          <div class="spark">
            <div class="cap">
              <div class="label">–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –¥–Ω—è–º</div>
              <span class="pill">spark</span>
            </div>
            ${spark}
          </div>` : ''
        }
      </div>

      ${
        topExpenses.length ? `
        <div class="card">
          <div class="row">
            <div>
              <div style="font-size: 16px; font-weight: 700;">–ö—Ä—É–ø–Ω—ã–µ —Ç—Ä–∞—Ç—ã</div>
              <div class="sub">–ß—Ç–æ —Å–∏–ª—å–Ω–µ–µ –≤—Å–µ–≥–æ –¥–≤–∏–≥–∞–µ—Ç —Å—É–º–º—É</div>
            </div>
            <span class="pill">${topExpenses.slice(0,5).length} —à—Ç</span>
          </div>

          <div class="list">
            ${topExpenses.slice(0,5).map(x=>{
              const name = escapeHtml(x.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è');
              const cat = escapeHtml(x.category_name || x.category || '');
              const dt = escapeHtml(x.date || x.created_at || '');
              const colorClass = getExpenseColorClass(x.amount);
              return `
                <div class="item">
                  <div class="left">
                    <div class="name">${name}</div>
                    <div class="meta">${[cat, dt].filter(Boolean).join(' ‚Ä¢ ')}</div>
                  </div>
                  <div class="right">
                    <div class="amt ${colorClass}">${fmtMoney(x.amount, currency)}</div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>` : ''
      }
    `;
  } catch(e){
    app.innerHTML = `
      <div class="topbar">
        <div class="app-title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
        ${periodButtons()}
      </div>
      <div class="card">
        <div style="font-size: 16px; font-weight: 700;">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</div>
        <div class="sub">${escapeHtml(String(e.message || e))}</div>
        <button class="btn" onclick="showAnalytics()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
      </div>
    `;
  }
}

/* ======================================================
   –î–û–ë–ê–í–õ–ï–ù–ò–ï –¢–†–ê–¢–´ –ß–ï–†–ï–ó –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û
====================================================== */
async function submitExpenseModal(){
  const amount = document.getElementById('modalAmount')?.value;
  const description = document.getElementById('modalDescription')?.value || '';
  const date = document.getElementById('modalDate')?.value || nowISODate();

  if (!amount || Number(amount) <= 0){
    tg?.showAlert('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É');
    return;
  }

  try{
    await apiFetch(API.ADD_EXPENSE, { 
      amount: Number(amount), 
      description, 
      date 
    }, { 
      method: 'POST' 
    });

    tg?.HapticFeedback?.notificationOccurred('success');
    
    if (tg?.showPopup) {
      tg.showPopup({
        title: '–ì–æ—Ç–æ–≤–æ',
        message: '–¢—Ä–∞—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞',
        buttons: [{ type: 'ok' }]
      });
    } else {
      alert('–¢—Ä–∞—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
    }

    closeAddModal();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —ç–∫—Ä–∞–Ω
    if (activeScreen === 'dashboard') showDashboard();
    else if (activeScreen === 'analytics') showAnalytics();
    else if (activeScreen === 'recent') showRecent();
  } catch(e){
    tg?.HapticFeedback?.notificationOccurred('error');
    tg?.showAlert(`–û—à–∏–±–∫–∞: ${String(e.message || e)}`);
  }
}

/* ======================================================
   SCREEN: RECENT
====================================================== */
async function showRecent(){
  try {
    activeScreen = 'recent';
    setActiveTab(2);

    app.innerHTML = `
      <div class="topbar">
        <div class="app-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞—Ç—ã</div>
        ${periodButtons()}
      </div>
      ${loadingCard('–ó–∞–≥—Ä—É–∑–∫–∞...')}
    `;

    const data = unwrapN8n(await apiFetch(API.RECENT, { 
      period, 
      date: nowISODate(), 
      month: monthKey(), 
      limit: 25 
    }, { 
      method: 'POST' 
    }));
    
    const currency = data.currency || '‚ÇΩ';
    const items = Array.isArray(data.expenses) ? data.expenses : (Array.isArray(data) ? data : []);

    app.innerHTML = `
      <div class="topbar">
        <div class="app-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞—Ç—ã</div>
        ${periodButtons()}
      </div>

      <div class="card">
        <div class="row">
          <div>
            <div style="font-size: 16px; font-weight: 700;">–°–ø–∏—Å–æ–∫</div>
            <div class="sub">–ë—ã—Å—Ç—Ä–æ —É–¥–∞–ª–∏—Ç—å / –ø—Ä–æ–≤–µ—Ä–∏—Ç—å</div>
          </div>
          <span class="pill">${items.length} —à—Ç</span>
        </div>

        <div class="list">
          ${
            items.length ? items.map(x=>{
              const id = x.id || x.expense_id || '';
              const name = x.description || x.comment || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è';
              const cat = x.category || x.category_name || '';
              const dt = x.date || x.created_at || '';
              const safeId = escapeHtml(id);
              const safeName = escapeHtml(name);
              const safeCat = escapeHtml(cat);
              const safeDt = escapeHtml(dt);
              const colorClass = getExpenseColorClass(x.amount);
              
              return `
                <div class="item">
                  <div class="left">
                    <div class="name">${safeName}</div>
                    <div class="meta">${[safeCat, safeDt].filter(Boolean).join(' ‚Ä¢ ')}</div>
                  </div>
                  <div class="right">
                    <div class="amt ${colorClass}">${fmtMoney(x.amount, currency)}</div>
                    ${id ? `<button class="mini-btn danger" onclick="deleteExpense('${safeId}')">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
                  </div>
                </div>
              `;
            }).join('') : `<div class="sub">–ü–æ–∫–∞ –ø—É—Å—Ç–æ.</div>`
          }
        </div>
      </div>
    `;
  } catch(e){
    app.innerHTML = `
      <div class="topbar">
        <div class="app-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞—Ç—ã</div>
        ${periodButtons()}
      </div>
      <div class="card">
        <div style="font-size: 16px; font-weight: 700;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å</div>
        <div class="sub">${escapeHtml(String(e.message || e))}</div>
        <button class="btn" onclick="showRecent()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
      </div>
    `;
  }
}

async function deleteExpense(id){
  if (!id) return;

  const confirmDelete = () => {
    return new Promise((resolve) => {
      if (tg?.showPopup) {
        tg.showPopup({
          title: '–£–¥–∞–ª–∏—Ç—å?',
          message: '–¢—Ä–∞—Ç–∞ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞',
          buttons: [
            { id: 'cancel', type: 'cancel', text: '–û—Ç–º–µ–Ω–∞' },
            { id: 'ok', type: 'destructive', text: '–£–¥–∞–ª–∏—Ç—å' }
          ]
        }, (btnId) => {
          resolve(btnId === 'ok');
        });
      } else {
        resolve(confirm('–£–¥–∞–ª–∏—Ç—å —Ç—Ä–∞—Ç—É?'));
      }
    });
  };

  const shouldDelete = await confirmDelete();
  if (!shouldDelete) return;
  
  try {
    await apiFetch(API.DELETE_EXPENSE, { id }, { method: 'POST' });
    tg?.HapticFeedback?.notificationOccurred('success');
    showRecent();
  } catch(e) {
    tg?.HapticFeedback?.notificationOccurred('error');
    tg?.showAlert(`–û—à–∏–±–∫–∞: ${String(e.message || e)}`);
  }
}

/* ======================================================
   INIT
====================================================== */
// –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
try {
  showDashboard();
} catch (e) {
  app.innerHTML = `
    <div class="card">
      <div style="font-size: 16px; font-weight: 700;">–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞</div>
      <div class="sub">${escapeHtml(String(e.message || e))}</div>
      <button class="btn" onclick="showDashboard()">–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å</button>
    </div>
  `;
  console.error('App initialization error:', e);
}
</script>
</body>
</html>
