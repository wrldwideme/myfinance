<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Expenses Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg: #0b0b0f;
      --card: #1c1c1e;
      --muted: rgba(255,255,255,.65);
      --text: #ffffff;
      --border: rgba(255,255,255,.08);
      --accent: #2ea6ff;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --radius: 16px;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .wrap { padding: 14px 14px 88px; }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin: 6px 0 12px;
    }
    .app-title{
      font-weight: 700;
      font-size: 18px;
      letter-spacing: .2px;
    }

    .seg{
      display:flex;
      gap:6px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--border);
      padding: 6px;
      border-radius: 999px;
    }
    .seg button{
      border:0;
      background: transparent;
      color: var(--muted);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 13px;
      cursor:pointer;
    }
    .seg button.active{
      background: rgba(255,255,255,.10);
      color: var(--text);
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
      margin-bottom: 10px;
    }

    .row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }
    .label{
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 6px;
    }
    .big{
      font-size: 28px;
      font-weight: 800;
      letter-spacing: .2px;
      line-height: 1.1;
    }
    .sub{
      color: var(--muted);
      font-size: 13px;
      margin-top: 6px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border:1px solid var(--border);
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
    }
    .pill.warn{ color: #ffd479; }
    .pill.ok{ color: #8cffb1; }
    .pill.bad{ color: #ff8c8c; }

    .list{ margin-top: 6px; }
    .item{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding: 10px 0;
      border-top: 1px solid var(--border);
    }
    .item:first-child{ border-top: 0; }
    .item .left{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 0;
    }
    .item .name{
      font-size: 14px;
      font-weight: 600;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 230px;
    }
    .item .meta{
      color: var(--muted);
      font-size: 12px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .item .right{
      text-align:right;
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-end;
    }
    .amt{
      font-weight: 800;
      font-size: 14px;
    }
    .mini-btn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 12px;
      cursor:pointer;
    }
    .mini-btn.danger{ color: #ff9a9a; }

    .btn{
      width: 100%;
      border:0;
      background: var(--accent);
      color: #001018;
      font-weight: 800;
      padding: 14px 14px;
      border-radius: 14px;
      cursor:pointer;
      font-size: 16px;
      margin-top: 10px;
    }

    .input{
      width: 100%;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 16px;
      outline: none;
    }
    .input::placeholder{ color: rgba(255,255,255,.35); }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .nav{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      background: rgba(18,18,22,.92);
      backdrop-filter: blur(14px);
      border-top: 1px solid var(--border);
      display:flex;
      gap: 8px;
    }
    .nav button{
      flex: 1;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      padding: 10px 8px;
      border-radius: 14px;
      font-size: 13px;
      cursor:pointer;
    }
    .nav button.active{
      color: var(--text);
      border-color: rgba(46,166,255,.35);
      background: rgba(46,166,255,.14);
    }

    .hint{
      color: rgba(255,255,255,.45);
      font-size: 12px;
      margin-top: 8px;
      line-height: 1.35;
    }

    .divider{
      height: 1px;
      background: var(--border);
      margin: 10px 0;
    }

    .loading{
      display:flex; gap:10px; align-items:center; color: var(--muted);
    }
    .dot{
      width: 8px; height: 8px; border-radius: 50%;
      background: rgba(255,255,255,.25);
      animation: pulse 1s infinite ease-in-out;
    }
    .dot:nth-child(2){ animation-delay: .15s; }
    .dot:nth-child(3){ animation-delay: .3s; }
    @keyframes pulse{
      0%,100%{ transform: scale(1); opacity: .5; }
      50%{ transform: scale(1.35); opacity: 1; }
    }
  
    /* Analytics visuals */
    .kpis{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .kpi{
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      border-radius: 16px;
      padding: 12px;
    }
    .kpi .kpi-label{ font-size: 12px; color: var(--muted); }
    .kpi .kpi-value{ font-size: 20px; font-weight: 800; margin-top: 6px; }
    .kpi .kpi-sub{ font-size: 12px; color: var(--muted); margin-top: 6px; }

    .donut-wrap{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap: 12px;
      align-items:center;
      margin-top: 10px;
    }
    .donut{
      width: 140px;
      height: 140px;
      border-radius: 50%;
      background: conic-gradient(rgba(255,255,255,.12) 0 360deg);
      position: relative;
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
    }
    .donut::after{
      content:'';
      position:absolute;
      inset: 16px;
      border-radius: 50%;
      background: rgba(15,20,27,.92);
      border: 1px solid rgba(255,255,255,.08);
    }
    .donut-center{
      position:absolute;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      z-index: 1;
      pointer-events:none;
      text-align:center;
      padding: 0 14px;
    }
    .donut-center .dc-big{ font-weight: 900; font-size: 16px; }
    .donut-center .dc-sub{ font-size: 12px; color: var(--muted); margin-top: 4px; }

    .legend{
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    .legend-row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding: 8px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.14);
    }
    .legend-left{
      display:flex;
      align-items:flex-start;
      gap:10px;
      min-width: 0;
    }
    .dotc{
      width: 10px; height: 10px;
      border-radius: 999px;
      margin-top: 4px;
      flex: 0 0 auto;
      background: rgba(255,255,255,.30);
      border: 1px solid rgba(255,255,255,.18);
    }
    .legend-name{
      font-size: 13px;
      font-weight: 700;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 180px;
    }
    .legend-sub{
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }
    .spark{
      margin-top: 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.14);
      padding: 10px;
    }
    .spark svg{ width: 100%; height: 70px; display:block; }
    .spark .spark-meta{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-top: 8px;
      color: var(--muted);
      font-size: 12px;
    }
    .muted{ color: var(--muted); }

  </style>
</head>

<body>
  <div id="app" class="wrap"></div>

  <div class="nav">
    <button id="tab0" onclick="showDashboard()" class="active">üè† –°–µ–π—á–∞—Å</button>
    <button id="tab1" onclick="showAnalytics()">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
    <button id="tab2" onclick="showAdd()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
    <button id="tab3" onclick="showRecent()">üßæ –¢—Ä–∞—Ç—ã</button>
  </div>

<script>
/* ======================================================
   TELEGRAM INIT
====================================================== */
const tg = window.Telegram?.WebApp;
if (tg) {
  tg.expand();
  const p = tg.themeParams || {};
  if (p.bg_color) document.documentElement.style.setProperty('--bg', p.bg_color);
  if (p.text_color) document.documentElement.style.setProperty('--text', p.text_color);
  if (p.hint_color) document.documentElement.style.setProperty('--muted', p.hint_color);
  if (p.button_color) document.documentElement.style.setProperty('--accent', p.button_color);
}

/* ======================================================
   üîå API WEBHOOKS (–í–°–ï –° –ü–†–ï–§–ò–ö–°–û–ú fin- –ò /webhook-test/)
   –ú–µ–Ω—è–µ—à—å —Ç—É—Ç –æ–¥–∏–Ω —Ä–∞–∑ ‚Äî –∏ –≤—Å—ë.
====================================================== */
const N8N_BASE = 'https://n8n.todobotmy.ru/webhook';

const API = {
  // –£ –¢–ï–ë–Ø –£–ñ–ï –ï–°–¢–¨ (GET):
  DASHBOARD: `${N8N_BASE}/fin-dashboard`,

  // –ó–∞–≥–ª—É—à–∫–∏ –ø–æ–¥ –±—É–¥—É—â–∏–µ n8n webhooks (–ø–µ—Ä–µ–∏–º–µ–Ω—É–µ—à—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏):
  ANALYTICS: `${N8N_BASE}/fin-analytics`,
  RECENT: `${N8N_BASE}/fin-expenses-recent`,
  ADD_EXPENSE: `${N8N_BASE}/fin-expenses-add`,
  UPDATE_EXPENSE: `${N8N_BASE}/fin-expenses-update`,
  DELETE_EXPENSE: `${N8N_BASE}/fin-expenses-delete`
};

const app = document.getElementById('app');

/* ======================================================
   HELPERS
====================================================== */
function setActiveTab(i){
  for (let k=0;k<4;k++){
    document.getElementById('tab'+k).classList.toggle('active', k===i);
  }
}

function fmtMoney(n, currency='‚ÇΩ'){
  if (n === null || n === undefined || n === '') return '‚Äî';
  const num = Number(n);
  if (Number.isNaN(num)) return String(n);
  return new Intl.NumberFormat('ru-RU').format(num) + ' ' + currency;
}

function nowISODate(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}

function monthKey(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  return `${yyyy}-${mm}`;
}

function loadingCard(text='–ó–∞–≥—Ä—É–∑–∫–∞'){
  return `
    <div class="card">
      <div class="loading">
        <span>${text}</span>
        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
      </div>
    </div>
  `;
}

function buildUrl(url, params){
  const u = new URL(url);
  Object.entries(params || {}).forEach(([k,v]) => {
    if (v !== undefined && v !== null && v !== '') u.searchParams.set(k, String(v));
  });
  return u.toString();
}

/**
 * GET: params –∏–¥—É—Ç –≤ query string
 * POST: JSON body (–¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ n8n)
 * initData –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö –≤—Å–µ–≥–¥–∞.
 */
async function apiFetch(url, payload={}, opts={}){
  const initData = tg?.initData || '';
  const method = (opts.method || 'POST').toUpperCase();

  const finalUrl = method === 'GET' ? buildUrl(url, {
    ...payload,
    telegram_user_id: tg?.initDataUnsafe?.user?.id
  }) : url;

  const res = await fetch(finalUrl, {
    method,
    headers: {
      ...(method === 'GET' ? {} : { 'Content-Type': 'application/json' }),
      'Authorization': initData,
      'X-Telegram-InitData': initData
    },
    body: method === 'GET' ? undefined : JSON.stringify({
      ...payload,
      initData,
      telegram_user_id: tg?.initDataUnsafe?.user?.id
    })
  });

  if (!res.ok) {
    const t = await res.text().catch(()=> '');
    throw new Error(`HTTP ${res.status}: ${t || 'Request failed'}`);
  }

  const ct = res.headers.get('content-type') || '';
  if (ct.includes('application/json')) return await res.json();
  const text = await res.text();
  try { return JSON.parse(text); } catch { return { raw: text }; }
}

/* ======================================================
   STATE
====================================================== */
let period = 'month'; // today | week | month
let activeScreen = 'dashboard';

function periodButtons(){
  return `
    <div class="seg" role="tablist" aria-label="–ü–µ—Ä–∏–æ–¥">
      <button class="${period==='today'?'active':''}" onclick="setPeriod('today')">–°–µ–≥–æ–¥–Ω—è</button>
      <button class="${period==='week'?'active':''}" onclick="setPeriod('week')">–ù–µ–¥–µ–ª—è</button>
      <button class="${period==='month'?'active':''}" onclick="setPeriod('month')">–ú–µ—Å—è—Ü</button>
    </div>
  `;
}

function setPeriod(p){
  period = p;
  if (activeScreen === 'dashboard') showDashboard();
  if (activeScreen === 'analytics') showAnalytics();
  if (activeScreen === 'recent') showRecent();
}

/* ======================================================
   SCREEN: DASHBOARD (GET)
====================================================== */
async function showDashboard(){
  activeScreen = 'dashboard';
  setActiveTab(0);

  app.innerHTML = `
    <div class="topbar">
      <div class="app-title">–†–∞—Å—Ö–æ–¥—ã</div>
      ${periodButtons()}
    </div>
    ${loadingCard('Dashboard')}
  `;

  try {
    // GET params ‚Äî –ø–æ–¥—Å—Ç—Ä–æ–∏—à—å –ø–æ–¥ —Ç–æ, —á—Ç–æ –∂–¥—ë—Ç —Ç–≤–æ–π fin-dashboard
    const params = {
      period,               // today/week/month
      date: nowISODate(),   // —É–¥–æ–±–Ω–æ –¥–ª—è today/week
      month: monthKey()     // —É–¥–æ–±–Ω–æ –¥–ª—è month
    };

    const data = await apiFetch(API.DASHBOARD, params, { method: 'GET' });

    const currency = data.currency || '‚ÇΩ';
    const budgets = Array.isArray(data.budgets) ? data.budgets : [];
    const insight = data.insight || null;

    app.innerHTML = `
      <div class="topbar">
        <div class="app-title">–†–∞—Å—Ö–æ–¥—ã</div>
        ${periodButtons()}
      </div>

      <div class="card">
        <div class="label">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ (${period==='today'?'—Å–µ–≥–æ–¥–Ω—è':period==='week'?'–∑–∞ –Ω–µ–¥–µ–ª—é':'–∑–∞ –º–µ—Å—è—Ü'})</div>
        <div class="big">${fmtMoney(data.spent, currency)}</div>
        ${data.forecast !== undefined ? `<div class="sub">–ü—Ä–æ–≥–Ω–æ–∑: ${fmtMoney(data.forecast, currency)}</div>` : ''}
      </div>

      ${
        budgets.length ? `
        <div class="card">
          <div class="row">
            <div>
              <div class="title">–ë—é–¥–∂–µ—Ç—ã</div>
              <div class="sub">–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ç—É—Å –ø–æ –ª–∏–º–∏—Ç–∞–º</div>
            </div>
            <span class="pill">–ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</span>
          </div>
          <div class="list">
            ${budgets.slice(0,5).map(b=>{
              const pct = b.percent ?? (b.limit ? Math.round((b.spent/b.limit)*100) : null);
              let cls = 'ok';
              if (pct >= 100) cls = 'bad';
              else if (pct >= 80) cls = 'warn';
              return `
                <div class="item">
                  <div class="left">
                    <div class="name">${b.category_name || b.category || '–ö–∞—Ç–µ–≥–æ—Ä–∏—è'}</div>
                    <div class="meta">${fmtMoney(b.spent, currency)} –∏–∑ ${fmtMoney(b.limit, currency)}</div>
                  </div>
                  <div class="right">
                    <span class="pill ${cls}">${pct !== null ? (pct + '%') : '‚Äî'}</span>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
        ` : ''
      }

      ${
        insight?.text ? `
        <div class="card">
          <div class="row">
            <div>
              <div class="title">–ò–Ω—Å–∞–π—Ç</div>
              <div class="sub">${insight.text}</div>
            </div>
            <span class="pill">${insight.severity || 'info'}</span>
          </div>
        </div>
        ` : ''
      }
    `;
  } catch (e){
    app.innerHTML = `
      <div class="topbar">
        <div class="app-title">–†–∞—Å—Ö–æ–¥—ã</div>
        ${periodButtons()}
      </div>
      <div class="card">
        <div class="title">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
        <div class="sub">${String(e.message || e)}</div>
        <div class="divider"></div>
        <button class="btn" onclick="showDashboard()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
      </div>
    `;
    tg?.HapticFeedback?.notificationOccurred('error');
  }
}

/* ======================================================
   SCREEN: ANALYTICS (–ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞ –ø–æ–¥ —Ç–≤–æ–π –±—É–¥—É—â–∏–π fin-analytics)
====================================================== */
async function showAnalytics(){
  activeScreen = 'analytics';
  setActiveTab(1);

  app.innerHTML = `
    <div class="topbar">
      <div class="app-title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
      ${periodButtons()}
    </div>
    ${loadingCard('Analytics')}
  `;

  try{
    const data = await apiFetch(API.ANALYTICS, { period, date: nowISODate(), month: monthKey() }, { method: 'GET' });
    const currency = data.currency || '‚ÇΩ';

    // Categories
    let cats = Array.isArray(data.categories) ? data.categories.slice() : [];
    cats = cats
      .map(c => ({ name: (c.name ?? c.category_name ?? '–ö–∞—Ç–µ–≥–æ—Ä–∏—è'), amount: Number(c.amount) || 0 }))
      .filter(c => c.amount > 0)
      .sort((a,b) => b.amount - a.amount);

    const total = (Number(data.total) || 0) || cats.reduce((s,c)=> s + c.amount, 0);

    // Prev period comparison (optional)
    const prevTotal = Number(data.prev_total);
    const hasPrev = Number.isFinite(prevTotal);
    const delta = hasPrev ? (total - prevTotal) : null;
    const deltaPct = hasPrev ? (prevTotal > 0 ? Math.round((delta / prevTotal) * 100) : (total > 0 ? 100 : 0)) : null;

    // Donut: top 5 + other
    const MAX_SLICES = 5;
    const top = cats.slice(0, MAX_SLICES);
    const otherSum = cats.slice(MAX_SLICES).reduce((s,c)=> s + c.amount, 0);
    const donutCats = otherSum > 0 ? [...top, { name: '–ø—Ä–æ—á–µ–µ', amount: otherSum }] : top;

    // colors (light iOS-like)
    const palette = [
      'rgba(46,166,255,.90)',
      'rgba(124,92,255,.85)',
      'rgba(48,200,120,.85)',
      'rgba(255,200,80,.85)',
      'rgba(255,90,90,.80)',
      'rgba(255,255,255,.35)'
    ];

    const safeTotal = total > 0 ? total : 1;
    let acc = 0;
    const stops = donutCats.map((c, i) => {
      const frac = c.amount / safeTotal;
      const start = acc;
      acc += frac;
      const a = Math.round(start * 360);
      const b = Math.round(acc * 360);
      const col = palette[i % palette.length];
      return `${col} ${a}deg ${b}deg`;
    }).join(', ');

    const donutBg = total > 0
      ? `conic-gradient(${stops})`
      : `conic-gradient(rgba(255,255,255,.10) 0 360deg)`;

    // Timeline (optional): [{date, amount}]
    const timeline = Array.isArray(data.timeline) ? data.timeline
      .map(p => ({ date: String(p.date || ''), amount: Number(p.amount) || 0 }))
      .filter(p => p.date)
      : [];

    const points = timeline.map(p => p.amount);
    const hasTimeline = points.length >= 2;

    const avgPerDay = points.length ? Math.round(points.reduce((s,x)=>s+x,0) / points.length) : null;
    const maxDay = points.length ? Math.max(...points) : null;

    function sparklineSVG(values){
      const w = 320, h = 70, pad = 6;
      const maxV = Math.max(...values, 0);
      const minV = Math.min(...values, 0);
      const span = (maxV - minV) || 1;

      const step = (w - pad*2) / (values.length - 1);
      const pts = values.map((v, i) => {
        const x = pad + i * step;
        const y = pad + (h - pad*2) * (1 - ((v - minV) / span));
        return [x,y];
      });

      const d = pts.map((p,i)=> (i===0 ? `M ${p[0].toFixed(2)} ${p[1].toFixed(2)}` : `L ${p[0].toFixed(2)} ${p[1].toFixed(2)}`)).join(' ');
      const area = `${d} L ${(pad + (values.length - 1) * step).toFixed(2)} ${(h-pad).toFixed(2)} L ${pad.toFixed(2)} ${(h-pad).toFixed(2)} Z`;

      return `
        <svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none" aria-label="–ì—Ä–∞—Ñ–∏–∫ —Ç—Ä–∞—Ç">
          <path d="${area}" fill="rgba(46,166,255,.12)"></path>
          <path d="${d}" fill="none" stroke="rgba(46,166,255,.85)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"></path>
        </svg>
      `;
    }

    // Drivers (optional): top_expenses
    const topExpenses = Array.isArray(data.top_expenses) ? data.top_expenses.slice(0,5) : [];

    app.innerHTML = `
      <div class="topbar">
        <div class="app-title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
        ${periodButtons()}
      </div>

      <div class="card">
        <div class="title">–ò—Ç–æ–≥–∏</div>
        <div class="kpis">
          <div class="kpi">
            <div class="kpi-label">–í—Å–µ–≥–æ ‚Ä¢ ${periodLabel(period).toLowerCase()}</div>
            <div class="kpi-value">${fmtMoney(total, currency)}</div>
            <div class="kpi-sub">${cats.length ? `${cats.length} –∫–∞—Ç–µ–≥.` : '‚Äî'}</div>
          </div>

          <div class="kpi">
            <div class="kpi-label">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ</div>
            <div class="kpi-value">
              ${
                hasPrev
                  ? `${delta >= 0 ? '+' : '‚àí'}${fmtMoney(Math.abs(delta), currency)}`
                  : '‚Äî'
              }
            </div>
            <div class="kpi-sub">
              ${
                hasPrev
                  ? `${deltaPct >= 0 ? '+' : '‚àí'}${Math.abs(deltaPct)}% –∫ –ø—Ä–æ—à–ª–æ–º—É –ø–µ—Ä–∏–æ–¥—É`
                  : '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'
              }
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <div>
            <div class="title">–°—Ç—Ä—É–∫—Ç—É—Ä–∞</div>
            <div class="sub">–î–æ–ª–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</div>
          </div>
          <span class="pill info">${donutCats.length ? `${donutCats.length} —Å–µ–≥–º.` : '‚Äî'}</span>
        </div>

        <div class="donut-wrap">
          <div class="donut" style="background:${donutBg};">
            <div class="donut-center">
              <div class="dc-big">${total > 0 ? '100%' : '‚Äî'}</div>
              <div class="dc-sub">${total > 0 ? '–∑–∞ –ø–µ—Ä–∏–æ–¥' : '–Ω–µ—Ç —Ç—Ä–∞—Ç'}</div>
            </div>
          </div>

          <div class="legend">
            ${
              donutCats.length ? donutCats.map((c,i)=>{
                const pct = total > 0 ? Math.round((c.amount / total) * 100) : 0;
                const col = palette[i % palette.length];
                return `
                  <div class="legend-row">
                    <div class="legend-left">
                      <span class="dotc" style="background:${col};"></span>
                      <div style="min-width:0;">
                        <div class="legend-name">${c.name}</div>
                        <div class="legend-sub">${pct}% ‚Ä¢ ${fmtMoney(c.amount, currency)}</div>
                      </div>
                    </div>
                    <div class="amt">${pct}%</div>
                  </div>
                `;
              }).join('') : `<div class="sub">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</div>`
            }
          </div>
        </div>
      </div>

      ${
        hasTimeline ? `
        <div class="card">
          <div class="row">
            <div>
              <div class="title">–î–∏–Ω–∞–º–∏–∫–∞</div>
              <div class="sub">–¢—Ä–∞—Ç—ã –ø–æ –¥–Ω—è–º</div>
            </div>
            <span class="pill">${periodLabel(period)}</span>
          </div>

          <div class="spark">
            ${sparklineSVG(points)}
            <div class="spark-meta">
              <div>—Å—Ä–µ–¥–Ω–µ–µ: <b>${avgPerDay !== null ? fmtMoney(avgPerDay, currency) : '‚Äî'}</b></div>
              <div>–ø–∏–∫: <b>${maxDay !== null ? fmtMoney(maxDay, currency) : '‚Äî'}</b></div>
            </div>
          </div>
        </div>
        ` : ''
      }

      ${
        topExpenses.length ? `
        <div class="card">
          <div class="row">
            <div>
              <div class="title">–î—Ä–∞–π–≤–µ—Ä—ã</div>
              <div class="sub">–°–∞–º—ã–µ –∫—Ä—É–ø–Ω—ã–µ —Ç—Ä–∞—Ç—ã</div>
            </div>
            <span class="pill">${topExpenses.length} —à—Ç</span>
          </div>

          <div class="list">
            ${topExpenses.map(x=>{
              const name = x.description || x.comment || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è';
              const cat = x.category_name || x.category || '';
              const dt = x.date || x.created_at || '';
              return `
                <div class="item">
                  <div class="left">
                    <div class="name">${name}</div>
                    <div class="meta">${[cat, dt].filter(Boolean).join(' ‚Ä¢ ')}</div>
                  </div>
                  <div class="right">
                    <div class="amt">${fmtMoney(x.amount, currency)}</div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
        ` : ''
      }
    `;
  } catch(e){
    app.innerHTML = `
      <div class="card">
        <div class="title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</div>
        <div class="sub">${String(e.message || e)}</div>
        <button class="btn" onclick="showAnalytics()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
      </div>
    `;
  }
}

/* ======================================================
   SCREEN: ADD EXPENSE (–ø–æ–¥ fin-expenses-add)
====================================================== */
function showAdd(){
  activeScreen = 'add';
  setActiveTab(2);

  const today = nowISODate();

  app.innerHTML = `
    <div class="topbar">
      <div class="app-title">–î–æ–±–∞–≤–∏—Ç—å</div>
      <span class="pill">–±—ã—Å—Ç—Ä–æ</span>
    </div>

    <div class="card">
      <div class="label">–°—É–º–º–∞</div>
      <input class="input" id="amount" type="number" inputmode="decimal" placeholder="350" />

      <div class="label" style="margin-top:10px;">–û–ø–∏—Å–∞–Ω–∏–µ</div>
      <input class="input" id="description" placeholder="–∫–æ—Ñ–µ, —Ç–∞–∫—Å–∏, –ø—Ä–æ–¥—É–∫—Ç—ã..." />

      <div class="label" style="margin-top:10px;">–î–∞—Ç–∞</div>
      <input class="input" id="date" type="date" value="${today}" />

      <button class="btn" onclick="submitExpense()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  `;
}

async function submitExpense(){
  const amount = document.getElementById('amount').value;
  const description = document.getElementById('description').value || '';
  const date = document.getElementById('date').value || nowISODate();

  if (!amount || Number(amount) <= 0){
    tg?.showAlert('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É');
    return;
  }

  try{
    await apiFetch(API.ADD_EXPENSE, { amount: Number(amount), description, date }, { method: 'POST' });

    tg?.HapticFeedback?.notificationOccurred('success');
    tg?.showPopup({
      title: '–ì–æ—Ç–æ–≤–æ',
      message: '–¢—Ä–∞—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞',
      buttons: [{ type: 'ok' }]
    });

    showDashboard();
  } catch(e){
    tg?.HapticFeedback?.notificationOccurred('error');
    tg?.showAlert(`–û—à–∏–±–∫–∞: ${String(e.message || e)}`);
  }
}

/* ======================================================
   SCREEN: RECENT (–ø–æ–¥ fin-expenses-recent)
====================================================== */
async function showRecent(){
  activeScreen = 'recent';
  setActiveTab(3);

  app.innerHTML = `
    <div class="topbar">
      <div class="app-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞—Ç—ã</div>
      ${periodButtons()}
    </div>
    ${loadingCard('Recent')}
  `;

  try{
    const data = await apiFetch(API.RECENT, { period, date: nowISODate(), month: monthKey(), limit: 25 }, { method: 'POST' });
    const currency = data.currency || '‚ÇΩ';
    const items = Array.isArray(data.expenses) ? data.expenses : (Array.isArray(data) ? data : []);

    app.innerHTML = `
      <div class="topbar">
        <div class="app-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞—Ç—ã</div>
        ${periodButtons()}
      </div>

      <div class="card">
        <div class="row">
          <div>
            <div class="title">–°–ø–∏—Å–æ–∫</div>
            <div class="sub">–ë—ã—Å—Ç—Ä–æ —É–¥–∞–ª–∏—Ç—å / –ø—Ä–æ–≤–µ—Ä–∏—Ç—å</div>
          </div>
          <span class="pill">${items.length} —à—Ç</span>
        </div>

        <div class="list">
          ${
            items.length ? items.map(x=>{
              const id = x.id || x.expense_id || '';
              const name = x.description || x.comment || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è';
              const cat = x.category || x.category_name || '';
              const dt = x.date || x.created_at || '';
              return `
                <div class="item">
                  <div class="left">
                    <div class="name">${name}</div>
                    <div class="meta">${[cat, dt].filter(Boolean).join(' ‚Ä¢ ')}</div>
                  </div>
                  <div class="right">
                    <div class="amt">${fmtMoney(x.amount, currency)}</div>
                    ${id ? `<button class="mini-btn danger" onclick="deleteExpense('${id}')">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
                  </div>
                </div>
              `;
            }).join('') : `<div class="sub">–ü–æ–∫–∞ –ø—É—Å—Ç–æ.</div>`
          }
        </div>
      </div>
    `;
  } catch(e){
    app.innerHTML = `
      <div class="card">
        <div class="title">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å</div>
        <div class="sub">${String(e.message || e)}</div>
        <button class="btn" onclick="showRecent()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
      </div>
    `;
  }
}

async function deleteExpense(id){
  if (!id) return;

  if (tg){
    tg.showPopup({
      title: '–£–¥–∞–ª–∏—Ç—å?',
      message: '–¢—Ä–∞—Ç–∞ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞',
      buttons: [
        { id: 'cancel', type: 'cancel', text: '–û—Ç–º–µ–Ω–∞' },
        { id: 'ok', type: 'destructive', text: '–£–¥–∞–ª–∏—Ç—å' }
      ]
    }, async (btnId) => {
      if (btnId !== 'ok') return;
      try{
        await apiFetch(API.DELETE_EXPENSE, { id }, { method: 'POST' });
        tg.HapticFeedback?.notificationOccurred('success');
        showRecent();
      } catch(e){
        tg.HapticFeedback?.notificationOccurred('error');
        tg.showAlert(`–û—à–∏–±–∫–∞: ${String(e.message || e)}`);
      }
    });
  } else {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç—Ä–∞—Ç—É?')) return;
    await apiFetch(API.DELETE_EXPENSE, { id }, { method: 'POST' });
    showRecent();
  }
}

/* ======================================================
   INIT
====================================================== */
showDashboard();
</script>
</body>
</html>
